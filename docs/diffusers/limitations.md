# Limitations

Due to differences in framework, some APIs & models will not be identical to [huggingface/diffusers](https://github.com/huggingface/diffusers) in the foreseeable future.

## APIs

### `xxx.from_pretrained`

- `torch_dtype` is renamed to `mindspore_dtype`
- `device_map`, `max_memory`, `offload_folder`, `offload_state_dict`, `low_cpu_mem_usage` will not be supported.

### `BaseOutput`

- Default value of `return_dict` is changed to `False`, for `GRAPH_MODE` does not allow to construct an instance of it.

### Output of `AutoencoderKL.encode`

Unlike the output `posterior = DiagonalGaussianDistribution(latent)`, which can do sampling by `posterior.sample()`.
We can only output the `latent` and then do sampling through `AutoencoderKL.diag_gauss_dist.sample(latent)`.

### `self.config` in `construct()`

For many models, parameters used in initialization will be registered in `self.config`. They are often accessed during the `construct` like using `if self.config.xxx == xxx` to determine execution paths in origin ü§ódiffusers. However getting attributes like this is not supported by static graph syntax of MindSpore. Two feasible replacement options are

- set new attributes in initialization for `self` like `self.xxx = self.config.xxx`, then use `self.xxx` in `construct` instead.
- use `self.config["xxx"]` as `self.config` is an `OrderedDict` and getting items like this is supported in static graph mode.

When `self.config.xxx` changed, we change `self.xxx` and `self.config["xxx"]` both.

## Models

The table below represents the current support in mindone/diffusers for each of those modules, whether they have support in Pynative fp16 mode, Graph fp16 mode, Pynative fp32 mode or Graph fp32 mode.

|              Names               | Pynative FP16 | Pynative FP32 | Graph FP16 | Graph FP32 |                       Description                       |  
|:--------------------------------:|:-------------:|:-------------:|:----------:|:----------:|:-------------------------------------------------------:|  
|        StableCascadeUNet         |       ‚ùå       |       ‚úÖ       |     ‚ùå      |     ‚úÖ      |  huggingface/diffusers output NaN when using float16.   |
|            nn.Conv3d             |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             FP32 is not supported on Ascend             |
|        TemporalConvLayer         |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |                   contains nn.Conv3d                    |
|       TemporalResnetBlock        |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |                   contains nn.Conv3d                    |
|      SpatioTemporalResBlock      |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |              contains TemporalResnetBlock               |
|     UNetMidBlock3DCrossAttn      |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |               contains TemporalConvLayer                |
|       CrossAttnDownBlock3D       |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |               contains TemporalConvLayer                |
|           DownBlock3D            |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |               contains TemporalConvLayer                |
|        CrossAttnUpBlock3D        |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |               contains TemporalConvLayer                |
|            UpBlock3D             |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |               contains TemporalConvLayer                |
|     MidBlockTemporalDecoder      |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
|      UpBlockTemporalDecoder      |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
|    UNetMidBlockSpatioTemporal    |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
|     DownBlockSpatioTemporal      |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
| CrossAttnDownBlockSpatioTemporal |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
|      UpBlockSpatioTemporal       |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
|  CrossAttnUpBlockSpatioTemporal  |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |             contains SpatioTemporalResBlock             |
|         TemporalDecoder          |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |    contains nn.Conv3d, MidBlockTemporalDecoder etc.     |
|       UNet3DConditionModel       |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |          contains UNetMidBlock3DCrossAttn etc.          |
|           I2VGenXLUNet           |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |          contains UNetMidBlock3DCrossAttn etc.          |
|   AutoencoderKLTemporalDecoder   |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |          contains MidBlockTemporalDecoder etc.          |
| UNetSpatioTemporalConditionModel |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      |        contains UNetMidBlockSpatioTemporal etc.         |
|          FirUpsample2D           |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      | ops.Conv2D has poor precision in fp16 and PyNative mode |
|         FirDownsample2D          |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      | ops.Conv2D has poor precision in fp16 and PyNative mode |
|        AttnSkipUpBlock2D         |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      |                 contains FirUpsample2D                  |
|          SkipUpBlock2D           |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      |                 contains FirUpsample2D                  |
|       AttnSkipDownBlock2D        |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      |                contains FirDownsample2D                 |
|         SkipDownBlock2D          |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      |                contains FirDownsample2D                 |
|   ResnetBlock2D (kernel='fir')   |       ‚ùå       |       ‚úÖ       |     ‚úÖ      |     ‚úÖ      | ops.Conv2D has poor precision in fp16 and PyNative mode |
|    CogVideoXTransformer3DModel   |       ‚úÖ       |       ‚ùå       |     ‚úÖ      |     ‚ùå      | Using FlashAttention which only supports FP16/BF16      |
|      AutoencoderKLCogVideoX      |       ‚úÖ       |       ‚ùå       |     ‚ùå      |     ‚ùå      | Only FP16/BF16: contains nn.Conv3d as sub cells & Only PyNative: Static Graph Syntax doesn't support cache operations inside |
|        CogVideoXEncoder3D        |       ‚úÖ       |       ‚ùå       |     ‚ùå      |     ‚ùå      | Only FP16/BF16: contains nn.Conv3d as sub cells & Only PyNative: Static Graph Syntax doesn't support cache operations inside |
|        CogVideoXDecoder3D        |       ‚úÖ       |       ‚ùå       |     ‚ùå      |     ‚ùå      | Only FP16/BF16: contains nn.Conv3d as sub cells & Only PyNative: Static Graph Syntax doesn't support cache operations inside |

## Pipelines
The table below represents the current support in mindone/diffusers for each of those pipelines in **MindSpore 2.3.1**,
whether they have support in Pynative fp16 mode, Graph fp16 mode, Pynative fp32 mode or Graph fp32 mode.

> precision issues of pipelines, the experiments in the table below default to upcasting GroupNorm to FP32 to avoid
> this issue.

|               **Pipelines**                | **Pynative FP16** | **Pynative FP32** | **Graph FP16** | **Graph FP32** |                                                                                  **Description**                                                                                   |
|:------------------------------------------:|:-----------------:|:-----------------:|:--------------:|:--------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|            AnimateDiffPipeline             |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      AnimateDiffVideoToVideoPipeline       |         ‚úÖ         |         ‚ùå         |       ‚úÖ        |       ‚úÖ        |                                                          In FP32 and Pynative mode, this pipeline will run out of memory                                                           |
|           BlipDiffusionPipeline            |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|          ConsistencyModelPipeline          |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|          CogVideoXPipeline                 |         ‚úÖ         |         ‚ùå         |       ‚ùå        |       ‚ùå        |   Flash Attention used in transformer and `nn.Conv3d` used in VAE only support FP16/BF16; Cache opeartions in VAE is not supported by MindSpore Graph Mode   |
|          CogVideoXImageToVideoPipeline     |         ‚úÖ         |         ‚ùå         |       ‚ùå        |       ‚ùå        |   Flash Attention used in transformer and `nn.Conv3d` used in VAE only support FP16/BF16; Cache opeartions in VAE is not supported by MindSpore Graph Mode   |
|          CogVideoXVideoToVideoPipeline     |         ‚úÖ         |         ‚ùå         |       ‚ùå        |       ‚ùå        |   Flash Attention used in transformer and `nn.Conv3d` used in VAE only support FP16/BF16; Cache opeartions in VAE is not supported by MindSpore Graph Mode   |
|                DDIMPipeline                |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|                DDPMPipeline                |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|                DiTPipeline                 |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|              I2VGenXLPipeline              |         ‚úÖ         |         ‚ùå         |       ‚úÖ        |       ‚ùå        | ops.bmm and ops.softmax have precision issues under FP16, so we need to upcast them to FP32 to get a good result; FP32 is not supported since I2VGenXLPipeline contains nn.Conv3d  |
|             IFImg2ImgPipeline              |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      IFImg2ImgSuperResolutionPipeline      |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|            IFInpaintingPipeline            |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|    IFInpaintingSuperResolutionPipeline     |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|                 IFPipeline                 |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|         IFSuperResolutionPipeline          |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|         Kandinsky3Img2ImgPipeline          |         ‚ùå         |         ‚ùå         |       ‚ùå        |       ‚ùå        |   Kandinsky3 only provides FP16 weights; additionally, T5 has precision issues, so to achieve the desired results, you need to directly input prompt_embeds and attention_mask.    |
|             Kandinsky3Pipeline             |         ‚ùå         |         ‚ùå         |       ‚ùå        |       ‚ùå        |   Kandinsky3 only provides FP16 weights; additionally, T5 has precision issues, so to achieve the desired results, you need to directly input prompt_embeds and attention_mask.    |
|          KandinskyImg2ImgPipeline          |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|          KandinskyInpaintPipeline          |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|             KandinskyPipeline              |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|   KandinskyV22ControlnetImg2ImgPipeline    |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       KandinskyV22ControlnetPipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|        KandinskyV22Img2ImgPipeline         |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|        KandinskyV22InpaintPipeline         |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|            KandinskyV22Pipeline            |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|   LatentConsistencyModelImg2ImgPipeline    |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       LatentConsistencyModelPipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|         LDMSuperResolutionPipeline         |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|           LDMTextToImagePipeline           |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|            PixArtAlphaPipeline             |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|            ShapEImg2ImgPipeline            |         ‚úÖ         |         ‚úÖ         |       ‚ùå        |       ‚ùå        |                                                                  The syntax in Render only supports Pynative mode                                                                  |
|               ShapEPipeline                |         ‚úÖ         |         ‚úÖ         |       ‚ùå        |       ‚ùå        |                                                                  The syntax in Render only supports Pynative mode                                                                  |
|           StableCascadePipeline            |         ‚ùå         |         ‚úÖ         |       ‚ùå        |       ‚úÖ        |                                                            This pipeline does not support FP16 due to precision issues                                                             |
|          StableDiffusion3Pipeline          |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       StableDiffusionAdapterPipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|  StableDiffusionControlNetImg2ImgPipeline  |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|  StableDiffusionControlNetInpaintPipeline  |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|     StableDiffusionControlNetPipeline      |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      StableDiffusionDepth2ImgPipeline      |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      StableDiffusionDiffEditPipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       StableDiffusionGLIGENPipeline        |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|   StableDiffusionGLIGENTextImagePipeline   |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|   StableDiffusionImageVariationPipeline    |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       StableDiffusionImg2ImgPipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       StableDiffusionInpaintPipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|   StableDiffusionInstructPix2PixPipeline   |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|    StableDiffusionLatentUpscalePipeline    |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|          StableDiffusionPipeline           |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|       StableDiffusionUpscalePipeline       |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      StableDiffusionXLAdapterPipeline      |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
| StableDiffusionXLControlNetImg2ImgPipeline |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
| StableDiffusionXLControlNetInpaintPipeline |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|    StableDiffusionXLControlNetPipeline     |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      StableDiffusionXLImg2ImgPipeline      |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|      StableDiffusionXLInpaintPipeline      |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|  StableDiffusionXLInstructPix2PixPipeline  |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|         StableDiffusionXLPipeline          |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|        StableVideoDiffusionPipeline        |         ‚úÖ         |         ‚ùå         |       ‚úÖ        |       ‚ùå        |         This pipeline will run out of memory under FP32; ops.bmm and ops.softmax have precision issues under FP16, so we need to upcast them to FP32 to get a good result          |
|        UnCLIPImageVariationPipeline        |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|               UnCLIPPipeline               |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                                                                                                                                                                    |
|             WuerstchenPipeline             |         ‚úÖ         |         ‚úÖ         |       ‚úÖ        |       ‚úÖ        |                                      GlobalResponseNorm has precision issue under FP16, so we need to upcast it to FP32 to get a good result                                       |
