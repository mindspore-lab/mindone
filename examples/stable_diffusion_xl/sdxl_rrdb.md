## SDXL+RRDB
[ESRGAN: Enhanced Super-Resolution Generative Adversarial Networks](https://arxiv.org/abs/1809.00219)

Residual-in-Residual Dense Block (RRDB) combines multi-level residual network and dense
connections. Based on the observation that more layers and connections could always boost
performance, the proposed RRDB employs a deeper and more complex structure than the original
residual block. Specifically the proposed RRDB has a residual-in-residual structure,
where residual learning is used in different levels, so the network capacity becomes higher
benefiting from the dense connections. Generally, RRDB used as an encoder in generative models
but due to a fact that this model pretrained as a SISR model may be used as an independent one.

## Dependency

- mindspore 2.2
- openmpi 4.0.3 (for distributed mode)

To install the dependency, please run

```shell
pip install -r requirements.txt
```

## Preparation

### Convert Pretrained Checkpoint

We provide a script for converting pre-trained weight from `.safetensors` to `.ckpt` in `tools/model_conversion/convert_weight.py`.

step1. Download the [Official](https://github.com/Stability-AI/generative-models) pre-train weights [SDXL-base-1.0](https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0) and [SDXL-refiner-1.0](https://huggingface.co/stabilityai/stable-diffusion-xl-refiner-1.0) from huggingface.

step2. Convert weight to MindSpore `.ckpt` format and put it to `./checkpoints/`.

```shell
cd tools/model_conversion

# convert sdxl-base-1.0 model
python convert_weight.py \
  --task pt_to_ms \
  --weight_safetensors /PATH TO/sd_xl_base_1.0.safetensors \
  --weight_ms /PATH TO/sd_xl_base_1.0_ms.ckpt \
  --key_torch torch_key_base.yaml \
  --key_ms mindspore_key_base.yaml

# convert sdxl-refiner-1.0 model
python convert_weight.py \
  --task pt_to_ms \
  --weight_safetensors /PATH TO/sd_xl_refiner_1.0.safetensors \
  --weight_ms /PATH TO/sd_xl_refiner_1.0_ms.ckpt \
  --key_torch torch_key_refiner.yaml \
  --key_ms mindspore_key_refiner.yaml
```

step3. Download the pre-train weights [RRDB](https://download.mindspore.cn/toolkits/mindediting/LLVT_opensource/RRDB/ckpt/rrdb_ascend_div2k_psnr30.68_20230524.ckpt) and put it to `./checkpoints/`.

## Inference

We provide a demo for text-to-image sampling in `demo/sampling_without_streamlit.py`.

The resolution of images generated by improving resolution through RRDB cannot exceed 2048.

Use generation sizes such as (512,512) by configuring `--sd_xl_base_ratios "1.0_512"` to control the size of generated images. Use scale factor by configuring `--scale 2` to control the ratio between the scale of a given original image and a new image. The current scale only supports 2 and 4.



After obtaining the weights, place them into checkpoints/. Next, start the demo using

```shell
# run sdxl-base txt2img without streamlit on Ascend
python demo/sampling_without_streamlit.py \
  --task txt2img \
  --config configs/inference/sd_xl_base.yaml \
  --weight checkpoints/sd_xl_base_1.0_ms.ckpt \
  --prompt "Astronaut in a jungle, cold color palette, muted colors, detailed, 8k" \
  --device_target Ascend \
  --add_sr True \
  --sr_config configs/inference/sd_xl_sr.yaml \
  --sr_weight checkpoints/rrdb_ascend_div2k_psnr30.68_20230524.ckpt \
  --scale 2

# run sdxl-refiner img2img without streamlit on Ascend
python demo/sampling_without_streamlit.py \
  --task img2img \
  --config configs/inference/sd_xl_refiner.yaml \
  --weight checkpoints/sd_xl_refiner_1.0_ms.ckpt \
  --prompt "Astronaut in a jungle, cold color palette, muted colors, detailed, 8k" \
  --img /PATH TO/img.jpg \
  --device_target Ascend
  --add_sr True \
  --sr_config configs/inference/sd_xl_sr.yaml \
  --sr_weight checkpoints/rrdb_ascend_div2k_psnr30.68_20230524.ckpt \
  --scale 2

# run pipeline without streamlit on Ascend
python demo/sampling_without_streamlit.py \
  --task txt2img \
  --config configs/inference/sd_xl_base.yaml \
  --weight checkpoints/sd_xl_base_1.0_ms.ckpt \
  --prompt "Astronaut in a jungle, cold color palette, muted colors, detailed, 8k" \
  --add_pipeline True \
  --pipeline_config configs/inference/sd_xl_refiner.yaml \
  --pipeline_weight checkpoints/sd_xl_refiner_1.0_ms.ckpt \
  --sd_xl_base_ratios "1.0_768" \
  --device_target Ascend
  --add_sr True \
  --sr_config configs/inference/sd_xl_sr.yaml \
  --sr_weight checkpoints/rrdb_ascend_div2k_psnr30.68_20230524.ckpt \
  --scale 2

# run super resolution without streamlit on Ascend
python demo/sampling_without_streamlit.py \
  --task super_resolution \
  --sr_img /PATH TO/img.jpg \
  --sr_config configs/inference/sd_xl_sr.yaml \
  --sr_weight checkpoints/rrdb_ascend_div2k_psnr30.68_20230524.ckpt \
  --scale 2
```

## Results

The figure below shows super-resolution results with RRDB.
<div align="center">
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/11d3de53-6843-4650-8089-f0a633d837d8" width="45%" />
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/48ff11d0-0aae-42b0-b583-57cbcefe3452" width="45%" />
</div>
<p align="center">
  <em> (1024, 1024) (left) and (2048, 2048) (right) Prompt: "Astronaut in a jungle, cold color palette, muted colors, detailed, 8k" </em>
</p>

Comparison results between RRDB and other upsampling models.
<div align="center">
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/9d4473a9-4612-4ec0-89fb-36c6d573e3cd" width="30%" />
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/f03278f9-e503-4d02-bada-99f263f5a92e" width="30%" />
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/c32c7b02-d4f0-48ac-92c7-10cf3002e8fc" width="30%" />
</div>
<p align="center">
<em> Fig1: INTER_LINEAR </em> <br>
<em> Fig2: INTER_NEAREST </em> <br>
<em> Fig3: RRDB </em> <br>
</p>

RRDB model recovers more details.
<div align="center">
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/299326ac-405e-4c09-8ff8-b74d2ddae593" width="30%" />
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/cbf7ce52-c75f-4c99-b95a-cf7beb282aa2" width="30%" />
<img src="https://github.com/mindspore-lab/mindone/assets/73014084/7cbce9d9-f985-4fcd-a762-a9aa6f2f09bb" width="30%" />
</div>
<p align="center">
<em> Fig4: INTER_LINEAR </em> <br>
<em> Fig5: INTER_NEAREST </em> <br>
<em> Fig6: RRDB </em> <br>
</p>
