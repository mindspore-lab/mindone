
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mindspore-lab.github.io/mindone/0.2/diffusers/api/pipelines/marigold/">
      
      
        <link rel="prev" href="../latent_diffusion/">
      
      
        <link rel="next" href="../pixart/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.43">
    
    
      
        <title>Marigold - MindOne - One for All</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,700,700i%7CIBM+Plex+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Source Sans Pro";--md-code-font:"IBM Plex Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#marigold-pipelines-for-computer-vision-tasks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="MindOne - One for All" class="md-header__button md-logo" aria-label="MindOne - One for All" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MindOne - One for All
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Marigold
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mindspore-lab/mindone" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    mindspore-lab/mindone
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../" class="md-tabs__link">
          
  
  Diffusers

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../transformers/" class="md-tabs__link">
          
  
  Transformers

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../peft/" class="md-tabs__link">
          
  
  PEFT

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="MindOne - One for All" class="md-nav__button md-logo" aria-label="MindOne - One for All" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MindOne - One for All
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mindspore-lab/mindone" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    mindspore-lab/mindone
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Diffusers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Diffusers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Get started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Get started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ðŸ§¨ Diffusers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quicktour/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quicktour
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stable_diffusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Effective and efficient diffusion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../limitations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Limitations
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/tutorial_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../using-diffusers/write_own_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Understanding pipelines, models and schedulers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/basic_training/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Train a diffusion model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/using_peft_for_inference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Load LoRAs for inference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_1" >
        
          
          <label class="md-nav__link" for="__nav_2_3_1" id="__nav_2_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Loaders
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_1">
            <span class="md-nav__icon md-icon"></span>
            Loaders
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loaders/ip_adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IP-Adapter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loaders/lora/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LoRA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loaders/peft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PEFT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loaders/single_file/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Single file
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loaders/textual_inversion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Textual Inversion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../loaders/unet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_2" >
        
          
          <label class="md-nav__link" for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/unet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNet1DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/unet2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNet2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/unet2d-cond/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNet2DConditionModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/unet3d-cond/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNet3DConditionModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/unet-motion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNetMotionModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/uvit2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UViT2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/vq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UVQModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/autoencoderkl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AutoEncoderKL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/asymmetricautoencoderkl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AsymmetricAutoEncoderKL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/autoencoder_tiny/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tiny AutoEncoder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/consistency_decoder_vae/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ConsistencyDecoderVae
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/transformer2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transformer2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/pixart_transformer2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PixArtTransformer2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/dit_transformer2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DiTTransformer2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/hunyuan_transformer2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HunyuanDiT2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/transformer_temporal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TransformerTemporalModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/sd3_transformer2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SD3Transformer2DModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/prior_transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PriorTransformer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/controlnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControlNetModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/controlnet_sd3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SD3ControlNetModel
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_3" id="__nav_2_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pipelines
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_3">
            <span class="md-nav__icon md-icon"></span>
            Pipelines
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../animatediff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AnimateDiff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../blip_diffusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BLIP-Diffusion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../consistency_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Consistency Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControlNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlnet_sd3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControlNet with Stable Diffusion 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlnetxs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControlNet-XS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlnetxs_sdxl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControlNet-XS with Stable Diffusion XL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dance_diffusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dance Diffusion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ddim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDIM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ddpm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deepfloyd_if/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepFloyd IF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../diffedit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DiffEdit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DiT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hunyuandit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hunyuan-DiT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../i2vgenxl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    I2VGen-XL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pix2pix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    InstructPix2Pix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kandinsky/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kandinsky 2.1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kandinsky_v22/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kandinsky 2.2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kandinsky3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kandinsky 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../latent_consistency_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latent Consistency Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../latent_diffusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latent Diffusion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Marigold
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Marigold
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#available-pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      Available Pipelines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#available-checkpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Available Checkpoints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldDepthPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldDepthPipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MarigoldDepthPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldDepthPipeline.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldDepthPipeline.ensemble_depth" class="md-nav__link">
    <span class="md-ellipsis">
      ensemble_depth
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldNormalsPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldNormalsPipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MarigoldNormalsPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldNormalsPipeline.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldNormalsPipeline.ensemble_normals" class="md-nav__link">
    <span class="md-ellipsis">
      ensemble_normals
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.pipelines.marigold.pipeline_marigold_depth.MarigoldDepthOutput" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldDepthOutput
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.pipelines.marigold.pipeline_marigold_normals.MarigoldNormalsOutput" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldNormalsOutput
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pixart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PixArt-Î±
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pixart_sigma/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PixArt-Î£
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shap_e/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shap-E
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_cascade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stable Cascade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../unclip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unCLIP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wuerstchen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wuerstchen
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_4" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4" id="__nav_2_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Internal Class
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4">
            <span class="md-nav__icon md-icon"></span>
            Internal Class
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal_classes_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../attnprocessor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Attention Processor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../activations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom activation functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../normalization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom Normalization Layer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../image_processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VAE Image Processor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../video_processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Video Processor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Transformers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Transformers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Get started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Get started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../transformers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ðŸ¤— Transformers
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PEFT
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            PEFT
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Get started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Get started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../peft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ðŸ¤— PEFT
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#available-pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      Available Pipelines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#available-checkpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Available Checkpoints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldDepthPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldDepthPipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MarigoldDepthPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldDepthPipeline.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldDepthPipeline.ensemble_depth" class="md-nav__link">
    <span class="md-ellipsis">
      ensemble_depth
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldNormalsPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldNormalsPipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MarigoldNormalsPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldNormalsPipeline.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      __call__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mindone.diffusers.MarigoldNormalsPipeline.ensemble_normals" class="md-nav__link">
    <span class="md-ellipsis">
      ensemble_normals
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.pipelines.marigold.pipeline_marigold_depth.MarigoldDepthOutput" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldDepthOutput
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mindone.diffusers.pipelines.marigold.pipeline_marigold_normals.MarigoldNormalsOutput" class="md-nav__link">
    <span class="md-ellipsis">
      MarigoldNormalsOutput
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/mindspore-lab/mindone/edit/master/docs/diffusers/api/pipelines/marigold.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/mindspore-lab/mindone/raw/master/docs/diffusers/api/pipelines/marigold.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<!--Copyright 2024 Marigold authors and The HuggingFace Team. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->

<h1 id="marigold-pipelines-for-computer-vision-tasks">Marigold Pipelines for Computer Vision Tasks<a class="headerlink" href="#marigold-pipelines-for-computer-vision-tasks" title="Permanent link">&para;</a></h1>
<p><img alt="marigold" src="https://marigoldmonodepth.github.io/images/teaser_collage_compressed.jpg" /></p>
<p>Marigold was proposed in <a href="https://huggingface.co/papers/2312.02145">Repurposing Diffusion-Based Image Generators for Monocular Depth Estimation</a>, a CVPR 2024 Oral paper by <a href="http://www.kebingxin.com/">Bingxin Ke</a>, <a href="https://www.obukhov.ai/">Anton Obukhov</a>, <a href="https://shengyuh.github.io/">Shengyu Huang</a>, <a href="https://nandometzger.github.io/">Nando Metzger</a>, <a href="https://rcdaudt.github.io/">Rodrigo Caye Daudt</a>, and <a href="https://scholar.google.com/citations?user=FZuNgqIAAAAJ&amp;hl=en">Konrad Schindler</a>.
The idea is to repurpose the rich generative prior of Text-to-Image Latent Diffusion Models (LDMs) for traditional computer vision tasks.
Initially, this idea was explored to fine-tune Stable Diffusion for Monocular Depth Estimation, as shown in the teaser above.
Later,
- <a href="https://tianfwang.github.io/">Tianfu Wang</a> trained the first Latent Consistency Model (LCM) of Marigold, which unlocked fast single-step inference;
- <a href="https://www.linkedin.com/in/kevin-qu-b3417621b/?locale=en_US">Kevin Qu</a> extended the approach to Surface Normals Estimation;
- <a href="https://www.obukhov.ai/">Anton Obukhov</a> contributed the pipelines and documentation into diffusers (enabled and supported by <a href="https://yiyixuxu.github.io/">YiYi Xu</a> and <a href="https://sayak.dev/">Sayak Paul</a>).</p>
<p>The abstract from the paper is:</p>
<p><em>Monocular depth estimation is a fundamental computer vision task. Recovering 3D depth from a single image is geometrically ill-posed and requires scene understanding, so it is not surprising that the rise of deep learning has led to a breakthrough. The impressive progress of monocular depth estimators has mirrored the growth in model capacity, from relatively modest CNNs to large Transformer architectures. Still, monocular depth estimators tend to struggle when presented with images with unfamiliar content and layout, since their knowledge of the visual world is restricted by the data seen during training, and challenged by zero-shot generalization to new domains. This motivates us to explore whether the extensive priors captured in recent generative diffusion models can enable better, more generalizable depth estimation. We introduce Marigold, a method for affine-invariant monocular depth estimation that is derived from Stable Diffusion and retains its rich prior knowledge. The estimator can be fine-tuned in a couple of days on a single GPU using only synthetic training data. It delivers state-of-the-art performance across a wide range of datasets, including over 20% performance gains in specific cases. Project page: https://marigoldmonodepth.github.io.</em></p>
<h2 id="available-pipelines">Available Pipelines<a class="headerlink" href="#available-pipelines" title="Permanent link">&para;</a></h2>
<p>Each pipeline supports one Computer Vision task, which takes an input RGB image as input and produces a <em>prediction</em> of the modality of interest, such as a depth map of the input image.
Currently, the following tasks are implemented:</p>
<table>
<thead>
<tr>
<th>Pipeline</th>
<th>Predicted Modalities</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/mindspore-lab/mindone/tree/master/mindone/diffusers/pipelines/marigold/pipeline_marigold_depth.py">MarigoldDepthPipeline</a></td>
<td><a href="https://en.wikipedia.org/wiki/Depth_map">Depth</a>, <a href="https://en.wikipedia.org/wiki/Binocular_disparity">Disparity</a></td>
</tr>
<tr>
<td><a href="https://github.com/mindspore-lab/mindone/tree/master/mindone/diffusers/pipelines/marigold/pipeline_marigold_normals.py">MarigoldNormalsPipeline</a></td>
<td><a href="https://en.wikipedia.org/wiki/Normal_mapping">Surface normals</a></td>
</tr>
</tbody>
</table>
<h2 id="available-checkpoints">Available Checkpoints<a class="headerlink" href="#available-checkpoints" title="Permanent link">&para;</a></h2>
<p>The original checkpoints can be found under the <a href="https://huggingface.co/prs-eth/">PRS-ETH</a> Hugging Face organization.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Make sure to check out the Schedulers <a href="../../using-diffusers/schedulers.md">guide</a> to learn how to explore the tradeoff between scheduler speed and quality, and see the <a href="../../using-diffusers/loading.md">reuse components across pipelines</a> section to learn how to efficiently load the same components into multiple pipelines. Also, to know more about reducing the memory usage of this pipeline, refer to the ["Reduce memory usage"] section <a href="../../using-diffusers/svd.md">here</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Marigold pipelines were designed and tested only with <code>DDIMScheduler</code> and <code>LCMScheduler</code>.
Depending on the scheduler, the number of inference steps required to get reliable predictions varies, and there is no universal value that works best across schedulers.
Because of that, the default value of <code>num_inference_steps</code> in the <code>__call__</code> method of the pipeline is set to <code>None</code> (see the API reference).
Unless set explicitly, its value will be taken from the checkpoint configuration <code>model_index.json</code>.
This is done to ensure high-quality predictions when calling the pipeline with just the <code>image</code> argument.</p>
</div>


<div class="doc doc-object doc-class">



<h2 id="mindone.diffusers.MarigoldDepthPipeline" class="doc doc-heading">
            <code>mindone.diffusers.MarigoldDepthPipeline</code>


<a href="#mindone.diffusers.MarigoldDepthPipeline" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="mindone.diffusers.pipelines.pipeline_utils.DiffusionPipeline" href="../overview/#mindone.diffusers.DiffusionPipeline">DiffusionPipeline</a></code></p>


        <p>Pipeline for monocular depth estimation using the Marigold method: https://marigoldmonodepth.github.io.</p>
<p>This model inherits from [<code>DiffusionPipeline</code>]. Check the superclass documentation for the generic methods the
library implements for all the pipelines (such as downloading or saving, running on a particular device, etc.)</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>unet</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Conditional U-Net to denoise the depth latent, conditioned on image latent.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`UNet2DConditionModel`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>vae</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Variational Auto-Encoder (VAE) Model to encode and decode images and predictions to and from latent
representations.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`AutoencoderKL`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>scheduler</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>A scheduler to be used in combination with <code>unet</code> to denoise the encoded image latents.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`DDIMScheduler` or `LCMScheduler`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>text_encoder</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Text-encoder, for empty text embedding.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`CLIPTextModel`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>tokenizer</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>CLIP tokenizer.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`CLIPTokenizer`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prediction_type</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Type of predictions made by the model.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>scale_invariant</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>A model property specifying whether the predicted depth maps are scale-invariant. This value must be set in
the model config. When used together with the <code>shift_invariant=True</code> flag, the model is also called
"affine-invariant". NB: overriding this value is not supported.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>shift_invariant</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>A model property specifying whether the predicted depth maps are shift-invariant. This value must be set in
the model config. When used together with the <code>scale_invariant=True</code> flag, the model is also called
"affine-invariant". NB: overriding this value is not supported.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>default_denoising_steps</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The minimum number of denoising diffusion steps that are required to produce a prediction of reasonable
quality with the given model. This value must be set in the model config. When the pipeline is called
without explicitly setting <code>num_inference_steps</code>, the default value is used. This is required to ensure
reasonable results with various model flavors compatible with the pipeline, such as those relying on very
short denoising schedules (<code>LCMScheduler</code>) and those with full diffusion schedules (<code>DDIMScheduler</code>).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>default_processing_resolution</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The recommended value of the <code>processing_resolution</code> parameter of the pipeline. This value must be set in
the model config. When the pipeline is called without explicitly setting <code>processing_resolution</code>, the
default value is used. This is required to ensure reasonable results with various model flavors trained
with varying optimal processing resolution values.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_depth.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MarigoldDepthPipeline</span><span class="p">(</span><span class="n">DiffusionPipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline for monocular depth estimation using the Marigold method: https://marigoldmonodepth.github.io.</span>

<span class="sd">    This model inherits from [`DiffusionPipeline`]. Check the superclass documentation for the generic methods the</span>
<span class="sd">    library implements for all the pipelines (such as downloading or saving, running on a particular device, etc.)</span>

<span class="sd">    Args:</span>
<span class="sd">        unet (`UNet2DConditionModel`):</span>
<span class="sd">            Conditional U-Net to denoise the depth latent, conditioned on image latent.</span>
<span class="sd">        vae (`AutoencoderKL`):</span>
<span class="sd">            Variational Auto-Encoder (VAE) Model to encode and decode images and predictions to and from latent</span>
<span class="sd">            representations.</span>
<span class="sd">        scheduler (`DDIMScheduler` or `LCMScheduler`):</span>
<span class="sd">            A scheduler to be used in combination with `unet` to denoise the encoded image latents.</span>
<span class="sd">        text_encoder (`CLIPTextModel`):</span>
<span class="sd">            Text-encoder, for empty text embedding.</span>
<span class="sd">        tokenizer (`CLIPTokenizer`):</span>
<span class="sd">            CLIP tokenizer.</span>
<span class="sd">        prediction_type (`str`, *optional*):</span>
<span class="sd">            Type of predictions made by the model.</span>
<span class="sd">        scale_invariant (`bool`, *optional*):</span>
<span class="sd">            A model property specifying whether the predicted depth maps are scale-invariant. This value must be set in</span>
<span class="sd">            the model config. When used together with the `shift_invariant=True` flag, the model is also called</span>
<span class="sd">            &quot;affine-invariant&quot;. NB: overriding this value is not supported.</span>
<span class="sd">        shift_invariant (`bool`, *optional*):</span>
<span class="sd">            A model property specifying whether the predicted depth maps are shift-invariant. This value must be set in</span>
<span class="sd">            the model config. When used together with the `scale_invariant=True` flag, the model is also called</span>
<span class="sd">            &quot;affine-invariant&quot;. NB: overriding this value is not supported.</span>
<span class="sd">        default_denoising_steps (`int`, *optional*):</span>
<span class="sd">            The minimum number of denoising diffusion steps that are required to produce a prediction of reasonable</span>
<span class="sd">            quality with the given model. This value must be set in the model config. When the pipeline is called</span>
<span class="sd">            without explicitly setting `num_inference_steps`, the default value is used. This is required to ensure</span>
<span class="sd">            reasonable results with various model flavors compatible with the pipeline, such as those relying on very</span>
<span class="sd">            short denoising schedules (`LCMScheduler`) and those with full diffusion schedules (`DDIMScheduler`).</span>
<span class="sd">        default_processing_resolution (`int`, *optional*):</span>
<span class="sd">            The recommended value of the `processing_resolution` parameter of the pipeline. This value must be set in</span>
<span class="sd">            the model config. When the pipeline is called without explicitly setting `processing_resolution`, the</span>
<span class="sd">            default value is used. This is required to ensure reasonable results with various model flavors trained</span>
<span class="sd">            with varying optimal processing resolution values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_cpu_offload_seq</span> <span class="o">=</span> <span class="s2">&quot;text_encoder-&gt;unet-&gt;vae&quot;</span>
    <span class="n">supported_prediction_types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;disparity&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unet</span><span class="p">:</span> <span class="n">UNet2DConditionModel</span><span class="p">,</span>
        <span class="n">vae</span><span class="p">:</span> <span class="n">AutoencoderKL</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DDIMScheduler</span><span class="p">,</span> <span class="n">LCMScheduler</span><span class="p">],</span>
        <span class="n">text_encoder</span><span class="p">:</span> <span class="n">CLIPTextModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">CLIPTokenizer</span><span class="p">,</span>
        <span class="n">prediction_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale_invariant</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">shift_invariant</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">default_denoising_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_processing_resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">prediction_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_prediction_types</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Potentially unsupported `prediction_type=&#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39;`; values supported by the pipeline: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">supported_prediction_types</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_modules</span><span class="p">(</span>
            <span class="n">unet</span><span class="o">=</span><span class="n">unet</span><span class="p">,</span>
            <span class="n">vae</span><span class="o">=</span><span class="n">vae</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">text_encoder</span><span class="o">=</span><span class="n">text_encoder</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_to_config</span><span class="p">(</span>
            <span class="n">prediction_type</span><span class="o">=</span><span class="n">prediction_type</span><span class="p">,</span>
            <span class="n">scale_invariant</span><span class="o">=</span><span class="n">scale_invariant</span><span class="p">,</span>
            <span class="n">shift_invariant</span><span class="o">=</span><span class="n">shift_invariant</span><span class="p">,</span>
            <span class="n">default_denoising_steps</span><span class="o">=</span><span class="n">default_denoising_steps</span><span class="p">,</span>
            <span class="n">default_processing_resolution</span><span class="o">=</span><span class="n">default_processing_resolution</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_invariant</span> <span class="o">=</span> <span class="n">scale_invariant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_invariant</span> <span class="o">=</span> <span class="n">shift_invariant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_denoising_steps</span> <span class="o">=</span> <span class="n">default_denoising_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_processing_resolution</span> <span class="o">=</span> <span class="n">default_processing_resolution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span> <span class="o">=</span> <span class="n">MarigoldImageProcessor</span><span class="p">(</span><span class="n">vae_scale_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">PipelineImageInput</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">processing_resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resample_method_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resample_method_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ensembling_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]],</span>
        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`num_inference_steps` is not specified and could not be resolved from the model config.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`num_inference_steps` must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ensemble_size` must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;`ensemble_size` == 2 results are similar to no ensembling (1); &quot;</span>
                <span class="s2">&quot;consider increasing the value to at least 3.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_invariant</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_invariant</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_scipy_available</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Make sure to install scipy if you want to use ensembling.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Computing uncertainty by setting `output_uncertainty=True` also requires setting `ensemble_size` &quot;</span>
                <span class="s2">&quot;greater than 1.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`processing_resolution` is not specified and could not be resolved from the model config.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`processing_resolution` must be non-negative: 0 for native resolution, or any positive value for &quot;</span>
                <span class="s2">&quot;downsampled processing.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`processing_resolution` must be a multiple of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resample_method_input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;nearest-exact&quot;</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`resample_method_input` takes string values compatible with PIL library: &quot;</span>
                <span class="s2">&quot;nearest, nearest-exact, bilinear, bicubic, area.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">resample_method_output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;nearest-exact&quot;</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`resample_method_output` takes string values compatible with PIL library: &quot;</span>
                <span class="s2">&quot;nearest, nearest-exact, bilinear, bicubic, area.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`batch_size` must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`output_type` must be one of `pt` or `np`.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`latents` and `generator` cannot be used together.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensembling_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensembling_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ensembling_kwargs` must be a dictionary.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;reduction&quot;</span> <span class="ow">in</span> <span class="n">ensembling_kwargs</span> <span class="ow">and</span> <span class="n">ensembling_kwargs</span><span class="p">[</span><span class="s2">&quot;reduction&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ensembling_kwargs[&#39;reduction&#39;]` can be either `&#39;mean&#39;` or `&#39;median&#39;`.&quot;</span><span class="p">)</span>

        <span class="c1"># image checks</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ops</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`image[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]` has unsupported dimensions or shape: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">H_i</span><span class="p">,</span> <span class="n">W_i</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">N_i</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">N_i</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                <span class="n">W_i</span><span class="p">,</span> <span class="n">H_i</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
                <span class="n">N_i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported `image[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]` type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">W_i</span><span class="p">,</span> <span class="n">H_i</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">W_i</span><span class="p">,</span> <span class="n">H_i</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Input `image[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]` has incompatible dimensions </span><span class="si">{</span><span class="p">(</span><span class="n">W_i</span><span class="p">,</span><span class="w"> </span><span class="n">H_i</span><span class="p">)</span><span class="si">}</span><span class="s2"> with the previous images </span><span class="si">{</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">num_images</span> <span class="o">+=</span> <span class="n">N_i</span>

        <span class="c1"># latents checks</span>
        <span class="k">if</span> <span class="n">latents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ops</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">latents</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`latents` must be a ms.Tensor.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">latents</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`latents` has unsupported dimensions or shape: </span><span class="si">{</span><span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">processing_resolution</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_orig</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
                <span class="n">new_H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">processing_resolution</span> <span class="o">//</span> <span class="n">max_orig</span>
                <span class="n">new_W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="n">processing_resolution</span> <span class="o">//</span> <span class="n">max_orig</span>
                <span class="k">if</span> <span class="n">new_H</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">new_W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extreme aspect ratio of the input image: [</span><span class="si">{</span><span class="n">W</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">H</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">new_W</span><span class="p">,</span> <span class="n">new_H</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span>
            <span class="n">shape_expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_channels</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">latents</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape_expected</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`latents` has unexpected shape=</span><span class="si">{</span><span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> expected=</span><span class="si">{</span><span class="n">shape_expected</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># generator checks</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The number of generators must match the total number of ensemble members for all input images.&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported generator type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">num_images</span>

    <span class="k">def</span> <span class="nf">progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_progress_bar_config&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`self._progress_bar_config` should be of type `dict`, but is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">progress_bar_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span><span class="p">)</span>
        <span class="n">progress_bar_config</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress_bar_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
        <span class="n">progress_bar_config</span><span class="p">[</span><span class="s2">&quot;leave&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress_bar_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leave&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="o">**</span><span class="n">progress_bar_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="o">**</span><span class="n">progress_bar_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either `total` or `iterable` has to be defined.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">PipelineImageInput</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">processing_resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">match_input_resolution</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">resample_method_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
        <span class="n">resample_method_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">ensembling_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">output_latent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function invoked when calling the pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (`PIL.Image.Image`, `np.ndarray`, `ms.Tensor`, `List[PIL.Image.Image]`, `List[np.ndarray]`),</span>
<span class="sd">                `List[ms.Tensor]`: An input image or images used as an input for the depth estimation task. For</span>
<span class="sd">                arrays and tensors, the expected value range is between `[0, 1]`. Passing a batch of images is possible</span>
<span class="sd">                by providing a four-dimensional array or a tensor. Additionally, a list of images of two- or</span>
<span class="sd">                three-dimensional arrays or tensors can be passed. In the latter case, all list elements must have the</span>
<span class="sd">                same width and height.</span>
<span class="sd">            num_inference_steps (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Number of denoising diffusion steps during inference. The default value `None` results in automatic</span>
<span class="sd">                selection. The number of steps should be at least 10 with the full Marigold models, and between 1 and 4</span>
<span class="sd">                for Marigold-LCM models.</span>
<span class="sd">            ensemble_size (`int`, defaults to `1`):</span>
<span class="sd">                Number of ensemble predictions. Recommended values are 5 and higher for better precision, or 1 for</span>
<span class="sd">                faster inference.</span>
<span class="sd">            processing_resolution (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Effective processing resolution. When set to `0`, matches the larger input image dimension. This</span>
<span class="sd">                produces crisper predictions, but may also lead to the overall loss of global context. The default</span>
<span class="sd">                value `None` resolves to the optimal value from the model config.</span>
<span class="sd">            match_input_resolution (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">                When enabled, the output prediction is resized to match the input dimensions. When disabled, the longer</span>
<span class="sd">                side of the output will equal to `processing_resolution`.</span>
<span class="sd">            resample_method_input (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">                Resampling method used to resize input images to `processing_resolution`. The accepted values are:</span>
<span class="sd">                `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">            resample_method_output (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">                Resampling method used to resize output predictions to match the input resolution. The accepted values</span>
<span class="sd">                are `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">            batch_size (`int`, *optional*, defaults to `1`):</span>
<span class="sd">                Batch size; only matters when setting `ensemble_size` or passing a tensor of images.</span>
<span class="sd">            ensembling_kwargs (`dict`, *optional*, defaults to `None`)</span>
<span class="sd">                Extra dictionary with arguments for precise ensembling control. The following options are available:</span>
<span class="sd">                - reduction (`str`, *optional*, defaults to `&quot;median&quot;`): Defines the ensembling function applied in</span>
<span class="sd">                  every pixel location, can be either `&quot;median&quot;` or `&quot;mean&quot;`.</span>
<span class="sd">                - regularizer_strength (`float`, *optional*, defaults to `0.02`): Strength of the regularizer that</span>
<span class="sd">                  pulls the aligned predictions to the unit range from 0 to 1.</span>
<span class="sd">                - max_iter (`int`, *optional*, defaults to `2`): Maximum number of the alignment solver steps. Refer to</span>
<span class="sd">                  `scipy.optimize.minimize` function, `options` argument.</span>
<span class="sd">                - tol (`float`, *optional*, defaults to `1e-3`): Alignment solver tolerance. The solver stops when the</span>
<span class="sd">                  tolerance is reached.</span>
<span class="sd">                - max_res (`int`, *optional*, defaults to `None`): Resolution at which the alignment is performed;</span>
<span class="sd">                  `None` matches the `processing_resolution`.</span>
<span class="sd">            latents (`ms.Tensor`, or `List[ms.Tensor]`, *optional*, defaults to `None`):</span>
<span class="sd">                Latent noise tensors to replace the random initialization. These can be taken from the previous</span>
<span class="sd">                function call&#39;s output.</span>
<span class="sd">            generator (`np.random.Generator`, or `List[np.random.Generator]`, *optional*, defaults to `None`):</span>
<span class="sd">                Random number generator object to ensure reproducibility.</span>
<span class="sd">            output_type (`str`, *optional*, defaults to `&quot;np&quot;`):</span>
<span class="sd">                Preferred format of the output&#39;s `prediction` and the optional `uncertainty` fields. The accepted</span>
<span class="sd">                values are: `&quot;np&quot;` (numpy array) or `&quot;pt&quot;` (torch tensor).</span>
<span class="sd">            output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                When enabled, the output&#39;s `uncertainty` field contains the predictive uncertainty map, provided that</span>
<span class="sd">                the `ensemble_size` argument is set to a value above 2.</span>
<span class="sd">            output_latent (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                When enabled, the output&#39;s `latent` field contains the latent codes corresponding to the predictions</span>
<span class="sd">                within the ensemble. These codes can be saved, modified, and used for subsequent calls with the</span>
<span class="sd">                `latents` argument.</span>
<span class="sd">            return_dict (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                Whether or not to return a [`~pipelines.marigold.MarigoldDepthOutput`] instead of a plain tuple.</span>

<span class="sd">        Examples:</span>

<span class="sd">        Returns:</span>
<span class="sd">            [`~pipelines.marigold.MarigoldDepthOutput`] or `tuple`:</span>
<span class="sd">                If `return_dict` is `True`, [`~pipelines.marigold.MarigoldDepthOutput`] is returned, otherwise a</span>
<span class="sd">                `tuple` is returned where the first element is the prediction, the second element is the uncertainty</span>
<span class="sd">                (or `None`), and the third is the latent (or `None`).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 0. Resolving variables.</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># Model-specific optimal default values leading to fast and reasonable results.</span>
        <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_inference_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_denoising_steps</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">processing_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_processing_resolution</span>

        <span class="c1"># 1. Check inputs.</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inputs</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">ensemble_size</span><span class="p">,</span>
            <span class="n">processing_resolution</span><span class="p">,</span>
            <span class="n">resample_method_input</span><span class="p">,</span>
            <span class="n">resample_method_output</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">ensembling_kwargs</span><span class="p">,</span>
            <span class="n">latents</span><span class="p">,</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="n">output_type</span><span class="p">,</span>
            <span class="n">output_uncertainty</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 2. Prepare empty text conditioning.</span>
        <span class="c1"># Model invocation: self.tokenizer, self.text_encoder.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">text_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
                <span class="n">prompt</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;do_not_pad&quot;</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text_input_ids</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">text_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span><span class="n">text_input_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [1,2,1024]</span>

        <span class="c1"># 3. Preprocess input images. This function loads input image or images of compatible dimensions `(H, W)`,</span>
        <span class="c1"># optionally downsamples them to the `processing_resolution` `(PH, PW)`, where</span>
        <span class="c1"># `max(PH, PW) == processing_resolution`, and pads the dimensions to `(PPH, PPW)` such that these values are</span>
        <span class="c1"># divisible by the latent space downscaling factor (typically 8 in Stable Diffusion). The default value `None`</span>
        <span class="c1"># of `processing_resolution` resolves to the optimal value from the model config. It is a recommended mode of</span>
        <span class="c1"># operation and leads to the most reasonable results. Using the native image resolution or any other processing</span>
        <span class="c1"># resolution can lead to loss of either fine details or global context in the output predictions.</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">original_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">processing_resolution</span><span class="p">,</span> <span class="n">resample_method_input</span><span class="p">,</span> <span class="n">dtype</span>
        <span class="p">)</span>  <span class="c1"># [N,3,PPH,PPW]</span>

        <span class="c1"># 4. Encode input image into latent space. At this step, each of the `N` input images is represented with `E`</span>
        <span class="c1"># ensemble members. Each ensemble member is an independent diffused prediction, just initialized independently.</span>
        <span class="c1"># Latents of each such predictions across all input images and all ensemble members are represented in the</span>
        <span class="c1"># `pred_latent` variable. The variable `image_latent` is of the same shape: it contains each input image encoded</span>
        <span class="c1"># into latent space and replicated `E` times. The latents can be either generated (see `generator` to ensure</span>
        <span class="c1"># reproducibility), or passed explicitly via the `latents` argument. The latter can be set outside the pipeline</span>
        <span class="c1"># code. For example, in the Marigold-LCM video processing demo, the latents initialization of a frame is taken</span>
        <span class="c1"># as a convex combination of the latents output of the pipeline for the previous frame and a newly-sampled</span>
        <span class="c1"># noise. This behavior can be achieved by setting the `output_latent` argument to `True`. The latent space</span>
        <span class="c1"># dimensions are `(h, w)`. Encoding into latent space happens in batches of size `batch_size`.</span>
        <span class="c1"># Model invocation: self.vae.encoder.</span>
        <span class="n">image_latent</span><span class="p">,</span> <span class="n">pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_latents</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span>
        <span class="p">)</span>  <span class="c1"># [N*E,4,h,w], [N*E,4,h,w]</span>

        <span class="k">del</span> <span class="n">image</span>

        <span class="n">batch_empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [B,1024,2]</span>

        <span class="c1"># 5. Process the denoising loop. All `N * E` latents are processed sequentially in batches of size `batch_size`.</span>
        <span class="c1"># The unet model takes concatenated latent spaces of the input image and the predicted modality as an input, and</span>
        <span class="c1"># outputs noise for the predicted modality&#39;s latent space. The number of denoising diffusion steps is defined by</span>
        <span class="c1"># `num_inference_steps`. It is either set directly, or resolves to the optimal value specific to the loaded</span>
        <span class="c1"># model.</span>
        <span class="c1"># Model invocation: self.unet.</span>
        <span class="n">pred_latents</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Marigold predictions...&quot;</span>
        <span class="p">):</span>
            <span class="n">batch_image_latent</span> <span class="o">=</span> <span class="n">image_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
            <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
            <span class="n">effective_batch_size</span> <span class="o">=</span> <span class="n">batch_image_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">batch_empty_text_embedding</span><span class="p">[:</span><span class="n">effective_batch_size</span><span class="p">]</span>  <span class="c1"># [B,2,1024]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_inference_steps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Diffusion steps...&quot;</span><span class="p">):</span>
                <span class="n">batch_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_image_latent</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B,8,h,w]</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">(</span><span class="n">batch_latent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
                <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[</span>
                    <span class="mi">0</span>
                <span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>

            <span class="n">pred_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_pred_latent</span><span class="p">)</span>

        <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pred_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

        <span class="k">del</span> <span class="p">(</span>
            <span class="n">pred_latents</span><span class="p">,</span>
            <span class="n">image_latent</span><span class="p">,</span>
            <span class="n">batch_empty_text_embedding</span><span class="p">,</span>
            <span class="n">batch_image_latent</span><span class="p">,</span>
            <span class="n">batch_pred_latent</span><span class="p">,</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">batch_latent</span><span class="p">,</span>
            <span class="n">noise</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 6. Decode predictions from latent into pixel space. The resulting `N * E` predictions have shape `(PPH, PPW)`,</span>
        <span class="c1"># which requires slight postprocessing. Decoding into pixel space happens in batches of size `batch_size`.</span>
        <span class="c1"># Model invocation: self.vae.decoder.</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">decode_prediction</span><span class="p">(</span><span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># [N*E,1,PPH,PPW]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_latent</span><span class="p">:</span>
            <span class="n">pred_latent</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 7. Remove padding. The output shape is (PH, PW).</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">unpad_image</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>  <span class="c1"># [N*E,1,PH,PW]</span>

        <span class="c1"># 8. Ensemble and compute uncertainty (when `output_uncertainty` is set). This code treats each of the `N`</span>
        <span class="c1"># groups of `E` ensemble predictions independently. For each group it computes an ensembled prediction of shape</span>
        <span class="c1"># `(PH, PW)` and an optional uncertainty map of the same dimensions. After computing this pair of outputs for</span>
        <span class="c1"># each group independently, it stacks them respectively into batches of `N` almost final predictions and</span>
        <span class="c1"># uncertainty maps.</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="o">*</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># [N,E,1,PH,PW]</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_depth</span><span class="p">(</span>
                    <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scale_invariant</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shift_invariant</span><span class="p">,</span>
                    <span class="n">output_uncertainty</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">(</span><span class="n">ensembling_kwargs</span> <span class="ow">or</span> <span class="p">{}),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">)</span>
            <span class="p">]</span>  <span class="c1"># [ [[1,1,PH,PW], [1,1,PH,PW]], ... ]</span>
            <span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [[1,1,PH,PW], ... ], [[1,1,PH,PW], ... ]</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,1,PH,PW]</span>
            <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,1,PH,PW]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 9. If `match_input_resolution` is set, the output prediction and the uncertainty are upsampled to match the</span>
        <span class="c1"># input resolution `(H, W)`. This step may introduce upsampling artifacts, and therefore can be disabled.</span>
        <span class="c1"># Depending on the downstream use-case, upsampling can be also chosen based on the tolerated artifacts by</span>
        <span class="c1"># setting the `resample_method_output` parameter (e.g., to `&quot;nearest&quot;`).</span>
        <span class="k">if</span> <span class="n">match_input_resolution</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
                <span class="n">prediction</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>  <span class="c1"># [N,1,H,W]</span>
            <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
                    <span class="n">uncertainty</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>  <span class="c1"># [N,1,H,W]</span>

        <span class="c1"># 10. Prepare the final outputs.</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [N,H,W,1]</span>
            <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">)</span>  <span class="c1"># [N,H,W,1]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">pred_latent</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">MarigoldDepthOutput</span><span class="p">(</span>
            <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">latent</span><span class="o">=</span><span class="n">pred_latent</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_latents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">],</span>
        <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="k">def</span> <span class="nf">retrieve_latents</span><span class="p">(</span><span class="n">encoder_output</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">ops</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span>
                <span class="n">encoder_output</span>
            <span class="p">),</span> <span class="s2">&quot;Could not access latents of provided encoder_output which is not a tensor&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="s2">&quot;diag_gauss_dist&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">diag_gauss_dist</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">encoder_output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">encoder_output</span>

        <span class="n">image_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">retrieve_latents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># [N,4,h,w]</span>
        <span class="n">image_latent</span> <span class="o">=</span> <span class="n">image_latent</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span>
        <span class="n">image_latent</span> <span class="o">=</span> <span class="n">image_latent</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

        <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">latents</span>
        <span class="k">if</span> <span class="n">pred_latent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">randn_tensor</span><span class="p">(</span>
                <span class="n">image_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">image_latent</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

        <span class="k">return</span> <span class="n">image_latent</span><span class="p">,</span> <span class="n">pred_latent</span>

    <span class="k">def</span> <span class="nf">decode_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_latent</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_channels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_channels</span><span class="si">}</span><span class="s2">,H,W]; got </span><span class="si">{</span><span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">pred_latent</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B,3,H,W]</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [B,1,H,W]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># [B,1,H,W]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="p">(</span><span class="n">prediction</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">return</span> <span class="n">prediction</span>  <span class="c1"># [B,1,H,W]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ensemble_depth</span><span class="p">(</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">scale_invariant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">shift_invariant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">regularizer_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">max_res</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensembles the depth maps represented by the `depth` tensor with expected shape `(B, 1, H, W)`, where B is the</span>
<span class="sd">        number of ensemble members for a given prediction of size `(H x W)`. Even though the function is designed for</span>
<span class="sd">        depth maps, it can also be used with disparity maps as long as the input tensor values are non-negative. The</span>
<span class="sd">        alignment happens when the predictions have one or more degrees of freedom, that is when they are either</span>
<span class="sd">        affine-invariant (`scale_invariant=True` and `shift_invariant=True`), or just scale-invariant (only</span>
<span class="sd">        `scale_invariant=True`). For absolute predictions (`scale_invariant=False` and `shift_invariant=False`)</span>
<span class="sd">        alignment is skipped and only ensembling is performed.</span>

<span class="sd">        Args:</span>
<span class="sd">            depth (`ms.Tensor`):</span>
<span class="sd">                Input ensemble depth maps.</span>
<span class="sd">            scale_invariant (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">                Whether to treat predictions as scale-invariant.</span>
<span class="sd">            shift_invariant (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">                Whether to treat predictions as shift-invariant.</span>
<span class="sd">            output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                Whether to output uncertainty map.</span>
<span class="sd">            reduction (`str`, *optional*, defaults to `&quot;median&quot;`):</span>
<span class="sd">                Reduction method used to ensemble aligned predictions. The accepted values are: `&quot;mean&quot;` and</span>
<span class="sd">                `&quot;median&quot;`.</span>
<span class="sd">            regularizer_strength (`float`, *optional*, defaults to `0.02`):</span>
<span class="sd">                Strength of the regularizer that pulls the aligned predictions to the unit range from 0 to 1.</span>
<span class="sd">            max_iter (`int`, *optional*, defaults to `2`):</span>
<span class="sd">                Maximum number of the alignment solver steps. Refer to `scipy.optimize.minimize` function, `options`</span>
<span class="sd">                argument.</span>
<span class="sd">            tol (`float`, *optional*, defaults to `1e-3`):</span>
<span class="sd">                Alignment solver tolerance. The solver stops when the tolerance is reached.</span>
<span class="sd">            max_res (`int`, *optional*, defaults to `1024`):</span>
<span class="sd">                Resolution at which the alignment is performed; `None` matches the `processing_resolution`.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A tensor of aligned and ensembled depth maps and optionally a tensor of uncertainties of the same shape:</span>
<span class="sd">            `(1, 1, H, W)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,1,H,W]; got </span><span class="si">{</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized reduction method: </span><span class="si">{</span><span class="n">reduction</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pure shift-invariant ensembling is not supported.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">init_param</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">init_min</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">init_max</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
                <span class="n">init_s</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">init_max</span> <span class="o">-</span> <span class="n">init_min</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">init_t</span> <span class="o">=</span> <span class="o">-</span><span class="n">init_s</span> <span class="o">*</span> <span class="n">init_min</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">init_s</span><span class="p">,</span> <span class="n">init_t</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">scale_invariant</span><span class="p">:</span>
                <span class="n">init_s</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">init_max</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">init_s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized alignment.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">param</span>

        <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
                <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">t</span>
            <span class="k">elif</span> <span class="n">scale_invariant</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized alignment.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">def</span> <span class="nf">ensemble</span><span class="p">(</span>
            <span class="n">depth_aligned</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">return_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">depth_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_uncertainty</span><span class="p">:</span>
                    <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">depth_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                <span class="c1"># ops.median has two return values and does not supported some data-type</span>
                <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">depth_aligned</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth_aligned</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_uncertainty</span><span class="p">:</span>
                    <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depth_aligned</span> <span class="o">-</span> <span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">uncertainty</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth_aligned</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized reduction method: </span><span class="si">{</span><span class="n">reduction</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span>

        <span class="k">def</span> <span class="nf">cost_fn</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">depth_aligned</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">)):</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">depth_aligned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">depth_aligned</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">diff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">regularizer_strength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prediction</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">depth_aligned</span><span class="p">,</span> <span class="n">return_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">err_near</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">-</span> <span class="n">prediction</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">err_far</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">prediction</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">err_near</span> <span class="o">+</span> <span class="n">err_far</span><span class="p">)</span> <span class="o">*</span> <span class="n">regularizer_strength</span>

            <span class="k">return</span> <span class="n">cost</span>

        <span class="k">def</span> <span class="nf">compute_param</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">scipy</span>

            <span class="n">depth_to_align</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">depth_to_align</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="n">max_res</span><span class="p">:</span>
                <span class="n">depth_to_align</span> <span class="o">=</span> <span class="n">MarigoldImageProcessor</span><span class="o">.</span><span class="n">resize_to_max_edge</span><span class="p">(</span><span class="n">depth_to_align</span><span class="p">,</span> <span class="n">max_res</span><span class="p">,</span> <span class="s2">&quot;nearest-exact&quot;</span><span class="p">)</span>

            <span class="n">param</span> <span class="o">=</span> <span class="n">init_param</span><span class="p">(</span><span class="n">depth_to_align</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                <span class="n">partial</span><span class="p">(</span><span class="n">cost_fn</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth_to_align</span><span class="p">),</span>
                <span class="n">param</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">max_iter</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

        <span class="n">requires_aligning</span> <span class="o">=</span> <span class="n">scale_invariant</span> <span class="ow">or</span> <span class="n">shift_invariant</span>
        <span class="n">ensemble_size</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">requires_aligning</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">compute_param</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

        <span class="n">depth</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">return_uncertainty</span><span class="o">=</span><span class="n">output_uncertainty</span><span class="p">)</span>

        <span class="n">depth_max</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
            <span class="n">depth_min</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scale_invariant</span><span class="p">:</span>
            <span class="n">depth_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized alignment.&quot;</span><span class="p">)</span>
        <span class="n">depth_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_max</span> <span class="o">-</span> <span class="n">depth_min</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="n">depth_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">depth_range</span>
        <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">/=</span> <span class="n">depth_range</span>

        <span class="k">return</span> <span class="n">depth</span><span class="p">,</span> <span class="n">uncertainty</span>  <span class="c1"># [1,1,H,W], [1,1,H,W]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="mindone.diffusers.MarigoldDepthPipeline.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mindone</span><span class="o">.</span><span class="n">diffusers</span><span class="o">.</span><span class="n">MarigoldDepthPipeline</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">num_inference_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">processing_resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_input_resolution</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample_method_input</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ensembling_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;np&#39;</span><span class="p">,</span> <span class="n">output_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_latent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#mindone.diffusers.MarigoldDepthPipeline.__call__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Function invoked when calling the pipeline.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>num_inference_steps</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Number of denoising diffusion steps during inference. The default value <code>None</code> results in automatic
selection. The number of steps should be at least 10 with the full Marigold models, and between 1 and 4
for Marigold-LCM models.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>ensemble_size</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Number of ensemble predictions. Recommended values are 5 and higher for better precision, or 1 for
faster inference.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, defaults to `1`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>1</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>processing_resolution</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Effective processing resolution. When set to <code>0</code>, matches the larger input image dimension. This
produces crisper predictions, but may also lead to the overall loss of global context. The default
value <code>None</code> resolves to the optimal value from the model config.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>match_input_resolution</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>When enabled, the output prediction is resized to match the input dimensions. When disabled, the longer
side of the output will equal to <code>processing_resolution</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `True`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resample_method_input</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Resampling method used to resize input images to <code>processing_resolution</code>. The accepted values are:
<code>"nearest"</code>, <code>"nearest-exact"</code>, <code>"bilinear"</code>, <code>"bicubic"</code>, or <code>"area"</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;bilinear&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;bilinear&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resample_method_output</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Resampling method used to resize output predictions to match the input resolution. The accepted values
are <code>"nearest"</code>, <code>"nearest-exact"</code>, <code>"bilinear"</code>, <code>"bicubic"</code>, or <code>"area"</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;bilinear&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;bilinear&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>batch_size</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Batch size; only matters when setting <code>ensemble_size</code> or passing a tensor of images.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `1`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>1</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>latents</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Latent noise tensors to replace the random initialization. These can be taken from the previous
function call's output.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`ms.Tensor`, or `List[ms.Tensor]`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>generator</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Random number generator object to ensure reproducibility.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`np.random.Generator`, or `List[np.random.Generator]`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_type</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Preferred format of the output's <code>prediction</code> and the optional <code>uncertainty</code> fields. The accepted
values are: <code>"np"</code> (numpy array) or <code>"pt"</code> (torch tensor).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;np&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;np&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_uncertainty</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>When enabled, the output's <code>uncertainty</code> field contains the predictive uncertainty map, provided that
the <code>ensemble_size</code> argument is set to a value above 2.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_latent</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>When enabled, the output's <code>latent</code> field contains the latent codes corresponding to the predictions
within the ensemble. These codes can be saved, modified, and used for subsequent calls with the
<code>latents</code> argument.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>return_dict</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether or not to return a [<code>~pipelines.marigold.MarigoldDepthOutput</code>] instead of a plain tuple.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>
        


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">RETURNS</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td class="doc-returns-details">
              <div class="doc-md-description">
                <p>[<code>~pipelines.marigold.MarigoldDepthOutput</code>] or <code>tuple</code>:
If <code>return_dict</code> is <code>True</code>, [<code>~pipelines.marigold.MarigoldDepthOutput</code>] is returned, otherwise a
<code>tuple</code> is returned where the first element is the prediction, the second element is the uncertainty
(or <code>None</code>), and the third is the latent (or <code>None</code>).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_depth.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">PipelineImageInput</span><span class="p">,</span>
    <span class="n">num_inference_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">processing_resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">match_input_resolution</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">resample_method_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
    <span class="n">resample_method_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ensembling_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span>
    <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_latent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function invoked when calling the pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (`PIL.Image.Image`, `np.ndarray`, `ms.Tensor`, `List[PIL.Image.Image]`, `List[np.ndarray]`),</span>
<span class="sd">            `List[ms.Tensor]`: An input image or images used as an input for the depth estimation task. For</span>
<span class="sd">            arrays and tensors, the expected value range is between `[0, 1]`. Passing a batch of images is possible</span>
<span class="sd">            by providing a four-dimensional array or a tensor. Additionally, a list of images of two- or</span>
<span class="sd">            three-dimensional arrays or tensors can be passed. In the latter case, all list elements must have the</span>
<span class="sd">            same width and height.</span>
<span class="sd">        num_inference_steps (`int`, *optional*, defaults to `None`):</span>
<span class="sd">            Number of denoising diffusion steps during inference. The default value `None` results in automatic</span>
<span class="sd">            selection. The number of steps should be at least 10 with the full Marigold models, and between 1 and 4</span>
<span class="sd">            for Marigold-LCM models.</span>
<span class="sd">        ensemble_size (`int`, defaults to `1`):</span>
<span class="sd">            Number of ensemble predictions. Recommended values are 5 and higher for better precision, or 1 for</span>
<span class="sd">            faster inference.</span>
<span class="sd">        processing_resolution (`int`, *optional*, defaults to `None`):</span>
<span class="sd">            Effective processing resolution. When set to `0`, matches the larger input image dimension. This</span>
<span class="sd">            produces crisper predictions, but may also lead to the overall loss of global context. The default</span>
<span class="sd">            value `None` resolves to the optimal value from the model config.</span>
<span class="sd">        match_input_resolution (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">            When enabled, the output prediction is resized to match the input dimensions. When disabled, the longer</span>
<span class="sd">            side of the output will equal to `processing_resolution`.</span>
<span class="sd">        resample_method_input (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">            Resampling method used to resize input images to `processing_resolution`. The accepted values are:</span>
<span class="sd">            `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">        resample_method_output (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">            Resampling method used to resize output predictions to match the input resolution. The accepted values</span>
<span class="sd">            are `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">        batch_size (`int`, *optional*, defaults to `1`):</span>
<span class="sd">            Batch size; only matters when setting `ensemble_size` or passing a tensor of images.</span>
<span class="sd">        ensembling_kwargs (`dict`, *optional*, defaults to `None`)</span>
<span class="sd">            Extra dictionary with arguments for precise ensembling control. The following options are available:</span>
<span class="sd">            - reduction (`str`, *optional*, defaults to `&quot;median&quot;`): Defines the ensembling function applied in</span>
<span class="sd">              every pixel location, can be either `&quot;median&quot;` or `&quot;mean&quot;`.</span>
<span class="sd">            - regularizer_strength (`float`, *optional*, defaults to `0.02`): Strength of the regularizer that</span>
<span class="sd">              pulls the aligned predictions to the unit range from 0 to 1.</span>
<span class="sd">            - max_iter (`int`, *optional*, defaults to `2`): Maximum number of the alignment solver steps. Refer to</span>
<span class="sd">              `scipy.optimize.minimize` function, `options` argument.</span>
<span class="sd">            - tol (`float`, *optional*, defaults to `1e-3`): Alignment solver tolerance. The solver stops when the</span>
<span class="sd">              tolerance is reached.</span>
<span class="sd">            - max_res (`int`, *optional*, defaults to `None`): Resolution at which the alignment is performed;</span>
<span class="sd">              `None` matches the `processing_resolution`.</span>
<span class="sd">        latents (`ms.Tensor`, or `List[ms.Tensor]`, *optional*, defaults to `None`):</span>
<span class="sd">            Latent noise tensors to replace the random initialization. These can be taken from the previous</span>
<span class="sd">            function call&#39;s output.</span>
<span class="sd">        generator (`np.random.Generator`, or `List[np.random.Generator]`, *optional*, defaults to `None`):</span>
<span class="sd">            Random number generator object to ensure reproducibility.</span>
<span class="sd">        output_type (`str`, *optional*, defaults to `&quot;np&quot;`):</span>
<span class="sd">            Preferred format of the output&#39;s `prediction` and the optional `uncertainty` fields. The accepted</span>
<span class="sd">            values are: `&quot;np&quot;` (numpy array) or `&quot;pt&quot;` (torch tensor).</span>
<span class="sd">        output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            When enabled, the output&#39;s `uncertainty` field contains the predictive uncertainty map, provided that</span>
<span class="sd">            the `ensemble_size` argument is set to a value above 2.</span>
<span class="sd">        output_latent (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            When enabled, the output&#39;s `latent` field contains the latent codes corresponding to the predictions</span>
<span class="sd">            within the ensemble. These codes can be saved, modified, and used for subsequent calls with the</span>
<span class="sd">            `latents` argument.</span>
<span class="sd">        return_dict (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether or not to return a [`~pipelines.marigold.MarigoldDepthOutput`] instead of a plain tuple.</span>

<span class="sd">    Examples:</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`~pipelines.marigold.MarigoldDepthOutput`] or `tuple`:</span>
<span class="sd">            If `return_dict` is `True`, [`~pipelines.marigold.MarigoldDepthOutput`] is returned, otherwise a</span>
<span class="sd">            `tuple` is returned where the first element is the prediction, the second element is the uncertainty</span>
<span class="sd">            (or `None`), and the third is the latent (or `None`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 0. Resolving variables.</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

    <span class="c1"># Model-specific optimal default values leading to fast and reasonable results.</span>
    <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_inference_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_denoising_steps</span>
    <span class="k">if</span> <span class="n">processing_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">processing_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_processing_resolution</span>

    <span class="c1"># 1. Check inputs.</span>
    <span class="n">num_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inputs</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">,</span>
        <span class="n">ensemble_size</span><span class="p">,</span>
        <span class="n">processing_resolution</span><span class="p">,</span>
        <span class="n">resample_method_input</span><span class="p">,</span>
        <span class="n">resample_method_output</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">ensembling_kwargs</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">,</span>
        <span class="n">output_type</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 2. Prepare empty text conditioning.</span>
    <span class="c1"># Model invocation: self.tokenizer, self.text_encoder.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">text_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;do_not_pad&quot;</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">text_input_ids</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">text_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span><span class="n">text_input_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [1,2,1024]</span>

    <span class="c1"># 3. Preprocess input images. This function loads input image or images of compatible dimensions `(H, W)`,</span>
    <span class="c1"># optionally downsamples them to the `processing_resolution` `(PH, PW)`, where</span>
    <span class="c1"># `max(PH, PW) == processing_resolution`, and pads the dimensions to `(PPH, PPW)` such that these values are</span>
    <span class="c1"># divisible by the latent space downscaling factor (typically 8 in Stable Diffusion). The default value `None`</span>
    <span class="c1"># of `processing_resolution` resolves to the optimal value from the model config. It is a recommended mode of</span>
    <span class="c1"># operation and leads to the most reasonable results. Using the native image resolution or any other processing</span>
    <span class="c1"># resolution can lead to loss of either fine details or global context in the output predictions.</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">original_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">processing_resolution</span><span class="p">,</span> <span class="n">resample_method_input</span><span class="p">,</span> <span class="n">dtype</span>
    <span class="p">)</span>  <span class="c1"># [N,3,PPH,PPW]</span>

    <span class="c1"># 4. Encode input image into latent space. At this step, each of the `N` input images is represented with `E`</span>
    <span class="c1"># ensemble members. Each ensemble member is an independent diffused prediction, just initialized independently.</span>
    <span class="c1"># Latents of each such predictions across all input images and all ensemble members are represented in the</span>
    <span class="c1"># `pred_latent` variable. The variable `image_latent` is of the same shape: it contains each input image encoded</span>
    <span class="c1"># into latent space and replicated `E` times. The latents can be either generated (see `generator` to ensure</span>
    <span class="c1"># reproducibility), or passed explicitly via the `latents` argument. The latter can be set outside the pipeline</span>
    <span class="c1"># code. For example, in the Marigold-LCM video processing demo, the latents initialization of a frame is taken</span>
    <span class="c1"># as a convex combination of the latents output of the pipeline for the previous frame and a newly-sampled</span>
    <span class="c1"># noise. This behavior can be achieved by setting the `output_latent` argument to `True`. The latent space</span>
    <span class="c1"># dimensions are `(h, w)`. Encoding into latent space happens in batches of size `batch_size`.</span>
    <span class="c1"># Model invocation: self.vae.encoder.</span>
    <span class="n">image_latent</span><span class="p">,</span> <span class="n">pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_latents</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span>
    <span class="p">)</span>  <span class="c1"># [N*E,4,h,w], [N*E,4,h,w]</span>

    <span class="k">del</span> <span class="n">image</span>

    <span class="n">batch_empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [B,1024,2]</span>

    <span class="c1"># 5. Process the denoising loop. All `N * E` latents are processed sequentially in batches of size `batch_size`.</span>
    <span class="c1"># The unet model takes concatenated latent spaces of the input image and the predicted modality as an input, and</span>
    <span class="c1"># outputs noise for the predicted modality&#39;s latent space. The number of denoising diffusion steps is defined by</span>
    <span class="c1"># `num_inference_steps`. It is either set directly, or resolves to the optimal value specific to the loaded</span>
    <span class="c1"># model.</span>
    <span class="c1"># Model invocation: self.unet.</span>
    <span class="n">pred_latents</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Marigold predictions...&quot;</span>
    <span class="p">):</span>
        <span class="n">batch_image_latent</span> <span class="o">=</span> <span class="n">image_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
        <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
        <span class="n">effective_batch_size</span> <span class="o">=</span> <span class="n">batch_image_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">batch_empty_text_embedding</span><span class="p">[:</span><span class="n">effective_batch_size</span><span class="p">]</span>  <span class="c1"># [B,2,1024]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_inference_steps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Diffusion steps...&quot;</span><span class="p">):</span>
            <span class="n">batch_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_image_latent</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B,8,h,w]</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">(</span><span class="n">batch_latent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
            <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[</span>
                <span class="mi">0</span>
            <span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>

        <span class="n">pred_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_pred_latent</span><span class="p">)</span>

    <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pred_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

    <span class="k">del</span> <span class="p">(</span>
        <span class="n">pred_latents</span><span class="p">,</span>
        <span class="n">image_latent</span><span class="p">,</span>
        <span class="n">batch_empty_text_embedding</span><span class="p">,</span>
        <span class="n">batch_image_latent</span><span class="p">,</span>
        <span class="n">batch_pred_latent</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">batch_latent</span><span class="p">,</span>
        <span class="n">noise</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 6. Decode predictions from latent into pixel space. The resulting `N * E` predictions have shape `(PPH, PPW)`,</span>
    <span class="c1"># which requires slight postprocessing. Decoding into pixel space happens in batches of size `batch_size`.</span>
    <span class="c1"># Model invocation: self.vae.decoder.</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decode_prediction</span><span class="p">(</span><span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># [N*E,1,PPH,PPW]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_latent</span><span class="p">:</span>
        <span class="n">pred_latent</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 7. Remove padding. The output shape is (PH, PW).</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">unpad_image</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>  <span class="c1"># [N*E,1,PH,PW]</span>

    <span class="c1"># 8. Ensemble and compute uncertainty (when `output_uncertainty` is set). This code treats each of the `N`</span>
    <span class="c1"># groups of `E` ensemble predictions independently. For each group it computes an ensembled prediction of shape</span>
    <span class="c1"># `(PH, PW)` and an optional uncertainty map of the same dimensions. After computing this pair of outputs for</span>
    <span class="c1"># each group independently, it stacks them respectively into batches of `N` almost final predictions and</span>
    <span class="c1"># uncertainty maps.</span>
    <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="o">*</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># [N,E,1,PH,PW]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_depth</span><span class="p">(</span>
                <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_invariant</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shift_invariant</span><span class="p">,</span>
                <span class="n">output_uncertainty</span><span class="p">,</span>
                <span class="o">**</span><span class="p">(</span><span class="n">ensembling_kwargs</span> <span class="ow">or</span> <span class="p">{}),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># [ [[1,1,PH,PW], [1,1,PH,PW]], ... ]</span>
        <span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [[1,1,PH,PW], ... ], [[1,1,PH,PW], ... ]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,1,PH,PW]</span>
        <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,1,PH,PW]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 9. If `match_input_resolution` is set, the output prediction and the uncertainty are upsampled to match the</span>
    <span class="c1"># input resolution `(H, W)`. This step may introduce upsampling artifacts, and therefore can be disabled.</span>
    <span class="c1"># Depending on the downstream use-case, upsampling can be also chosen based on the tolerated artifacts by</span>
    <span class="c1"># setting the `resample_method_output` parameter (e.g., to `&quot;nearest&quot;`).</span>
    <span class="k">if</span> <span class="n">match_input_resolution</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
            <span class="n">prediction</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>  <span class="c1"># [N,1,H,W]</span>
        <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
                <span class="n">uncertainty</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>  <span class="c1"># [N,1,H,W]</span>

    <span class="c1"># 10. Prepare the final outputs.</span>
    <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [N,H,W,1]</span>
        <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">)</span>  <span class="c1"># [N,H,W,1]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">pred_latent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MarigoldDepthOutput</span><span class="p">(</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
        <span class="n">latent</span><span class="o">=</span><span class="n">pred_latent</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mindone.diffusers.MarigoldDepthPipeline.ensemble_depth" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mindone</span><span class="o">.</span><span class="n">diffusers</span><span class="o">.</span><span class="n">MarigoldDepthPipeline</span><span class="o">.</span><span class="n">ensemble_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">scale_invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shift_invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">regularizer_strength</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_res</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#mindone.diffusers.MarigoldDepthPipeline.ensemble_depth" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Ensembles the depth maps represented by the <code>depth</code> tensor with expected shape <code>(B, 1, H, W)</code>, where B is the
number of ensemble members for a given prediction of size <code>(H x W)</code>. Even though the function is designed for
depth maps, it can also be used with disparity maps as long as the input tensor values are non-negative. The
alignment happens when the predictions have one or more degrees of freedom, that is when they are either
affine-invariant (<code>scale_invariant=True</code> and <code>shift_invariant=True</code>), or just scale-invariant (only
<code>scale_invariant=True</code>). For absolute predictions (<code>scale_invariant=False</code> and <code>shift_invariant=False</code>)
alignment is skipped and only ensembling is performed.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>depth</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Input ensemble depth maps.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>scale_invariant</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether to treat predictions as scale-invariant.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `True`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>shift_invariant</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether to treat predictions as shift-invariant.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `True`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_uncertainty</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether to output uncertainty map.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>reduction</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Reduction method used to ensemble aligned predictions. The accepted values are: <code>"mean"</code> and
<code>"median"</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;median&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;median&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>regularizer_strength</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Strength of the regularizer that pulls the aligned predictions to the unit range from 0 to 1.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`float`, *optional*, defaults to `0.02`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>0.02</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_iter</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Maximum number of the alignment solver steps. Refer to <code>scipy.optimize.minimize</code> function, <code>options</code>
argument.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `2`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>2</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>tol</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Alignment solver tolerance. The solver stops when the tolerance is reached.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`float`, *optional*, defaults to `1e-3`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>0.001</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_res</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Resolution at which the alignment is performed; <code>None</code> matches the <code>processing_resolution</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `1024`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>1024</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>
        

            <details class="quote">
              <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_depth.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">ensemble_depth</span><span class="p">(</span>
    <span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">scale_invariant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">shift_invariant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">max_res</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensembles the depth maps represented by the `depth` tensor with expected shape `(B, 1, H, W)`, where B is the</span>
<span class="sd">    number of ensemble members for a given prediction of size `(H x W)`. Even though the function is designed for</span>
<span class="sd">    depth maps, it can also be used with disparity maps as long as the input tensor values are non-negative. The</span>
<span class="sd">    alignment happens when the predictions have one or more degrees of freedom, that is when they are either</span>
<span class="sd">    affine-invariant (`scale_invariant=True` and `shift_invariant=True`), or just scale-invariant (only</span>
<span class="sd">    `scale_invariant=True`). For absolute predictions (`scale_invariant=False` and `shift_invariant=False`)</span>
<span class="sd">    alignment is skipped and only ensembling is performed.</span>

<span class="sd">    Args:</span>
<span class="sd">        depth (`ms.Tensor`):</span>
<span class="sd">            Input ensemble depth maps.</span>
<span class="sd">        scale_invariant (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">            Whether to treat predictions as scale-invariant.</span>
<span class="sd">        shift_invariant (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">            Whether to treat predictions as shift-invariant.</span>
<span class="sd">        output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether to output uncertainty map.</span>
<span class="sd">        reduction (`str`, *optional*, defaults to `&quot;median&quot;`):</span>
<span class="sd">            Reduction method used to ensemble aligned predictions. The accepted values are: `&quot;mean&quot;` and</span>
<span class="sd">            `&quot;median&quot;`.</span>
<span class="sd">        regularizer_strength (`float`, *optional*, defaults to `0.02`):</span>
<span class="sd">            Strength of the regularizer that pulls the aligned predictions to the unit range from 0 to 1.</span>
<span class="sd">        max_iter (`int`, *optional*, defaults to `2`):</span>
<span class="sd">            Maximum number of the alignment solver steps. Refer to `scipy.optimize.minimize` function, `options`</span>
<span class="sd">            argument.</span>
<span class="sd">        tol (`float`, *optional*, defaults to `1e-3`):</span>
<span class="sd">            Alignment solver tolerance. The solver stops when the tolerance is reached.</span>
<span class="sd">        max_res (`int`, *optional*, defaults to `1024`):</span>
<span class="sd">            Resolution at which the alignment is performed; `None` matches the `processing_resolution`.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A tensor of aligned and ensembled depth maps and optionally a tensor of uncertainties of the same shape:</span>
<span class="sd">        `(1, 1, H, W)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,1,H,W]; got </span><span class="si">{</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reduction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized reduction method: </span><span class="si">{</span><span class="n">reduction</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pure shift-invariant ensembling is not supported.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_param</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">init_min</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">init_max</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
            <span class="n">init_s</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">init_max</span> <span class="o">-</span> <span class="n">init_min</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">init_t</span> <span class="o">=</span> <span class="o">-</span><span class="n">init_s</span> <span class="o">*</span> <span class="n">init_min</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">init_s</span><span class="p">,</span> <span class="n">init_t</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scale_invariant</span><span class="p">:</span>
            <span class="n">init_s</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">init_max</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">init_s</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized alignment.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">param</span>

    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">t</span>
        <span class="k">elif</span> <span class="n">scale_invariant</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">*</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized alignment.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">ensemble</span><span class="p">(</span>
        <span class="n">depth_aligned</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">return_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">depth_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">depth_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="c1"># ops.median has two return values and does not supported some data-type</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">depth_aligned</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth_aligned</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">depth_aligned</span> <span class="o">-</span> <span class="n">prediction</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">uncertainty</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">depth_aligned</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized reduction method: </span><span class="si">{</span><span class="n">reduction</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span>

    <span class="k">def</span> <span class="nf">cost_fn</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">depth_aligned</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">)):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">depth_aligned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">depth_aligned</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">diff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">regularizer_strength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prediction</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">depth_aligned</span><span class="p">,</span> <span class="n">return_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">err_near</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">-</span> <span class="n">prediction</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">err_far</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">prediction</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">err_near</span> <span class="o">+</span> <span class="n">err_far</span><span class="p">)</span> <span class="o">*</span> <span class="n">regularizer_strength</span>

        <span class="k">return</span> <span class="n">cost</span>

    <span class="k">def</span> <span class="nf">compute_param</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">scipy</span>

        <span class="n">depth_to_align</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">depth_to_align</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="n">max_res</span><span class="p">:</span>
            <span class="n">depth_to_align</span> <span class="o">=</span> <span class="n">MarigoldImageProcessor</span><span class="o">.</span><span class="n">resize_to_max_edge</span><span class="p">(</span><span class="n">depth_to_align</span><span class="p">,</span> <span class="n">max_res</span><span class="p">,</span> <span class="s2">&quot;nearest-exact&quot;</span><span class="p">)</span>

        <span class="n">param</span> <span class="o">=</span> <span class="n">init_param</span><span class="p">(</span><span class="n">depth_to_align</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">cost_fn</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth_to_align</span><span class="p">),</span>
            <span class="n">param</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">max_iter</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

    <span class="n">requires_aligning</span> <span class="o">=</span> <span class="n">scale_invariant</span> <span class="ow">or</span> <span class="n">shift_invariant</span>
    <span class="n">ensemble_size</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">requires_aligning</span><span class="p">:</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">compute_param</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">align</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

    <span class="n">depth</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ensemble</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">return_uncertainty</span><span class="o">=</span><span class="n">output_uncertainty</span><span class="p">)</span>

    <span class="n">depth_max</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">scale_invariant</span> <span class="ow">and</span> <span class="n">shift_invariant</span><span class="p">:</span>
        <span class="n">depth_min</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">scale_invariant</span><span class="p">:</span>
        <span class="n">depth_min</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized alignment.&quot;</span><span class="p">)</span>
    <span class="n">depth_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth_max</span> <span class="o">-</span> <span class="n">depth_min</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="n">depth_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">depth_range</span>
    <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
        <span class="n">uncertainty</span> <span class="o">/=</span> <span class="n">depth_range</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">,</span> <span class="n">uncertainty</span>  <span class="c1"># [1,1,H,W], [1,1,H,W]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mindone.diffusers.MarigoldNormalsPipeline" class="doc doc-heading">
            <code>mindone.diffusers.MarigoldNormalsPipeline</code>


<a href="#mindone.diffusers.MarigoldNormalsPipeline" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="mindone.diffusers.pipelines.pipeline_utils.DiffusionPipeline" href="../overview/#mindone.diffusers.DiffusionPipeline">DiffusionPipeline</a></code></p>


        <p>Pipeline for monocular normals estimation using the Marigold method: https://marigoldmonodepth.github.io.</p>
<p>This model inherits from [<code>DiffusionPipeline</code>]. Check the superclass documentation for the generic methods the
library implements for all the pipelines (such as downloading or saving, running on a particular device, etc.)</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>unet</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Conditional U-Net to denoise the normals latent, conditioned on image latent.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`UNet2DConditionModel`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>vae</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Variational Auto-Encoder (VAE) Model to encode and decode images and predictions to and from latent
representations.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`AutoencoderKL`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>scheduler</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>A scheduler to be used in combination with <code>unet</code> to denoise the encoded image latents.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`DDIMScheduler` or `LCMScheduler`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>text_encoder</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Text-encoder, for empty text embedding.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`CLIPTextModel`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>tokenizer</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>CLIP tokenizer.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`CLIPTokenizer`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>prediction_type</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Type of predictions made by the model.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>use_full_z_range</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether the normals predicted by this model utilize the full range of the Z dimension, or only its positive
half.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>default_denoising_steps</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The minimum number of denoising diffusion steps that are required to produce a prediction of reasonable
quality with the given model. This value must be set in the model config. When the pipeline is called
without explicitly setting <code>num_inference_steps</code>, the default value is used. This is required to ensure
reasonable results with various model flavors compatible with the pipeline, such as those relying on very
short denoising schedules (<code>LCMScheduler</code>) and those with full diffusion schedules (<code>DDIMScheduler</code>).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>default_processing_resolution</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The recommended value of the <code>processing_resolution</code> parameter of the pipeline. This value must be set in
the model config. When the pipeline is called without explicitly setting <code>processing_resolution</code>, the
default value is used. This is required to ensure reasonable results with various model flavors trained
with varying optimal processing resolution values.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_normals.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MarigoldNormalsPipeline</span><span class="p">(</span><span class="n">DiffusionPipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline for monocular normals estimation using the Marigold method: https://marigoldmonodepth.github.io.</span>

<span class="sd">    This model inherits from [`DiffusionPipeline`]. Check the superclass documentation for the generic methods the</span>
<span class="sd">    library implements for all the pipelines (such as downloading or saving, running on a particular device, etc.)</span>

<span class="sd">    Args:</span>
<span class="sd">        unet (`UNet2DConditionModel`):</span>
<span class="sd">            Conditional U-Net to denoise the normals latent, conditioned on image latent.</span>
<span class="sd">        vae (`AutoencoderKL`):</span>
<span class="sd">            Variational Auto-Encoder (VAE) Model to encode and decode images and predictions to and from latent</span>
<span class="sd">            representations.</span>
<span class="sd">        scheduler (`DDIMScheduler` or `LCMScheduler`):</span>
<span class="sd">            A scheduler to be used in combination with `unet` to denoise the encoded image latents.</span>
<span class="sd">        text_encoder (`CLIPTextModel`):</span>
<span class="sd">            Text-encoder, for empty text embedding.</span>
<span class="sd">        tokenizer (`CLIPTokenizer`):</span>
<span class="sd">            CLIP tokenizer.</span>
<span class="sd">        prediction_type (`str`, *optional*):</span>
<span class="sd">            Type of predictions made by the model.</span>
<span class="sd">        use_full_z_range (`bool`, *optional*):</span>
<span class="sd">            Whether the normals predicted by this model utilize the full range of the Z dimension, or only its positive</span>
<span class="sd">            half.</span>
<span class="sd">        default_denoising_steps (`int`, *optional*):</span>
<span class="sd">            The minimum number of denoising diffusion steps that are required to produce a prediction of reasonable</span>
<span class="sd">            quality with the given model. This value must be set in the model config. When the pipeline is called</span>
<span class="sd">            without explicitly setting `num_inference_steps`, the default value is used. This is required to ensure</span>
<span class="sd">            reasonable results with various model flavors compatible with the pipeline, such as those relying on very</span>
<span class="sd">            short denoising schedules (`LCMScheduler`) and those with full diffusion schedules (`DDIMScheduler`).</span>
<span class="sd">        default_processing_resolution (`int`, *optional*):</span>
<span class="sd">            The recommended value of the `processing_resolution` parameter of the pipeline. This value must be set in</span>
<span class="sd">            the model config. When the pipeline is called without explicitly setting `processing_resolution`, the</span>
<span class="sd">            default value is used. This is required to ensure reasonable results with various model flavors trained</span>
<span class="sd">            with varying optimal processing resolution values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_cpu_offload_seq</span> <span class="o">=</span> <span class="s2">&quot;text_encoder-&gt;unet-&gt;vae&quot;</span>
    <span class="n">supported_prediction_types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;normals&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">unet</span><span class="p">:</span> <span class="n">UNet2DConditionModel</span><span class="p">,</span>
        <span class="n">vae</span><span class="p">:</span> <span class="n">AutoencoderKL</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DDIMScheduler</span><span class="p">,</span> <span class="n">LCMScheduler</span><span class="p">],</span>
        <span class="n">text_encoder</span><span class="p">:</span> <span class="n">CLIPTextModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">CLIPTokenizer</span><span class="p">,</span>
        <span class="n">prediction_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_full_z_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">default_denoising_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_processing_resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">prediction_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_prediction_types</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Potentially unsupported `prediction_type=&#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39;`; values supported by the pipeline: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">supported_prediction_types</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_modules</span><span class="p">(</span>
            <span class="n">unet</span><span class="o">=</span><span class="n">unet</span><span class="p">,</span>
            <span class="n">vae</span><span class="o">=</span><span class="n">vae</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">text_encoder</span><span class="o">=</span><span class="n">text_encoder</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_to_config</span><span class="p">(</span>
            <span class="n">use_full_z_range</span><span class="o">=</span><span class="n">use_full_z_range</span><span class="p">,</span>
            <span class="n">default_denoising_steps</span><span class="o">=</span><span class="n">default_denoising_steps</span><span class="p">,</span>
            <span class="n">default_processing_resolution</span><span class="o">=</span><span class="n">default_processing_resolution</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_full_z_range</span> <span class="o">=</span> <span class="n">use_full_z_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_denoising_steps</span> <span class="o">=</span> <span class="n">default_denoising_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_processing_resolution</span> <span class="o">=</span> <span class="n">default_processing_resolution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span> <span class="o">=</span> <span class="n">MarigoldImageProcessor</span><span class="p">(</span><span class="n">vae_scale_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">PipelineImageInput</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">processing_resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">resample_method_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resample_method_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ensembling_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]],</span>
        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`num_inference_steps` is not specified and could not be resolved from the model config.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`num_inference_steps` must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ensemble_size` must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;`ensemble_size` == 2 results are similar to no ensembling (1); &quot;</span>
                <span class="s2">&quot;consider increasing the value to at least 3.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Computing uncertainty by setting `output_uncertainty=True` also requires setting `ensemble_size` &quot;</span>
                <span class="s2">&quot;greater than 1.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`processing_resolution` is not specified and could not be resolved from the model config.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`processing_resolution` must be non-negative: 0 for native resolution, or any positive value for &quot;</span>
                <span class="s2">&quot;downsampled processing.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`processing_resolution` must be a multiple of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resample_method_input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;nearest-exact&quot;</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`resample_method_input` takes string values compatible with PIL library: &quot;</span>
                <span class="s2">&quot;nearest, nearest-exact, bilinear, bicubic, area.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">resample_method_output</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;nearest-exact&quot;</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`resample_method_output` takes string values compatible with PIL library: &quot;</span>
                <span class="s2">&quot;nearest, nearest-exact, bilinear, bicubic, area.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`batch_size` must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;np&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`output_type` must be one of `pt` or `np`.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">latents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`latents` and `generator` cannot be used together.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensembling_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensembling_kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ensembling_kwargs` must be a dictionary.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;reduction&quot;</span> <span class="ow">in</span> <span class="n">ensembling_kwargs</span> <span class="ow">and</span> <span class="n">ensembling_kwargs</span><span class="p">[</span><span class="s2">&quot;reduction&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ensembling_kwargs[&#39;reduction&#39;]` can be either `&#39;closest&#39;` or `&#39;mean&#39;`.&quot;</span><span class="p">)</span>

        <span class="c1"># image checks</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ops</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`image[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]` has unsupported dimensions or shape: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">H_i</span><span class="p">,</span> <span class="n">W_i</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">N_i</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">N_i</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
                <span class="n">W_i</span><span class="p">,</span> <span class="n">H_i</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
                <span class="n">N_i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported `image[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]` type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">W_i</span><span class="p">,</span> <span class="n">H_i</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">W_i</span><span class="p">,</span> <span class="n">H_i</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Input `image[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]` has incompatible dimensions </span><span class="si">{</span><span class="p">(</span><span class="n">W_i</span><span class="p">,</span><span class="w"> </span><span class="n">H_i</span><span class="p">)</span><span class="si">}</span><span class="s2"> with the previous images </span><span class="si">{</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">num_images</span> <span class="o">+=</span> <span class="n">N_i</span>

        <span class="c1"># latents checks</span>
        <span class="k">if</span> <span class="n">latents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ops</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">latents</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`latents` must be a ms.Tensor.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">latents</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`latents` has unsupported dimensions or shape: </span><span class="si">{</span><span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">processing_resolution</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_orig</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
                <span class="n">new_H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">processing_resolution</span> <span class="o">//</span> <span class="n">max_orig</span>
                <span class="n">new_W</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="n">processing_resolution</span> <span class="o">//</span> <span class="n">max_orig</span>
                <span class="k">if</span> <span class="n">new_H</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">new_W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extreme aspect ratio of the input image: [</span><span class="si">{</span><span class="n">W</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">H</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">new_W</span><span class="p">,</span> <span class="n">new_H</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span>
            <span class="n">shape_expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_channels</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">latents</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape_expected</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`latents` has unexpected shape=</span><span class="si">{</span><span class="n">latents</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> expected=</span><span class="si">{</span><span class="n">shape_expected</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># generator checks</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span> <span class="o">!=</span> <span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The number of generators must match the total number of ensemble members for all input images.&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported generator type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">num_images</span>

    <span class="k">def</span> <span class="nf">progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_progress_bar_config&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`self._progress_bar_config` should be of type `dict`, but is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">progress_bar_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_bar_config</span><span class="p">)</span>
        <span class="n">progress_bar_config</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress_bar_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
        <span class="n">progress_bar_config</span><span class="p">[</span><span class="s2">&quot;leave&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress_bar_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;leave&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="o">**</span><span class="n">progress_bar_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="o">**</span><span class="n">progress_bar_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either `total` or `iterable` has to be defined.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">PipelineImageInput</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">processing_resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">match_input_resolution</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">resample_method_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
        <span class="n">resample_method_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">ensembling_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">output_latent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function invoked when calling the pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (`PIL.Image.Image`, `np.ndarray`, `ms.Tensor`, `List[PIL.Image.Image]`, `List[np.ndarray]`),</span>
<span class="sd">                `List[ms.Tensor]`: An input image or images used as an input for the normals estimation task. For</span>
<span class="sd">                arrays and tensors, the expected value range is between `[0, 1]`. Passing a batch of images is possible</span>
<span class="sd">                by providing a four-dimensional array or a tensor. Additionally, a list of images of two- or</span>
<span class="sd">                three-dimensional arrays or tensors can be passed. In the latter case, all list elements must have the</span>
<span class="sd">                same width and height.</span>
<span class="sd">            num_inference_steps (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Number of denoising diffusion steps during inference. The default value `None` results in automatic</span>
<span class="sd">                selection. The number of steps should be at least 10 with the full Marigold models, and between 1 and 4</span>
<span class="sd">                for Marigold-LCM models.</span>
<span class="sd">            ensemble_size (`int`, defaults to `1`):</span>
<span class="sd">                Number of ensemble predictions. Recommended values are 5 and higher for better precision, or 1 for</span>
<span class="sd">                faster inference.</span>
<span class="sd">            processing_resolution (`int`, *optional*, defaults to `None`):</span>
<span class="sd">                Effective processing resolution. When set to `0`, matches the larger input image dimension. This</span>
<span class="sd">                produces crisper predictions, but may also lead to the overall loss of global context. The default</span>
<span class="sd">                value `None` resolves to the optimal value from the model config.</span>
<span class="sd">            match_input_resolution (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">                When enabled, the output prediction is resized to match the input dimensions. When disabled, the longer</span>
<span class="sd">                side of the output will equal to `processing_resolution`.</span>
<span class="sd">            resample_method_input (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">                Resampling method used to resize input images to `processing_resolution`. The accepted values are:</span>
<span class="sd">                `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">            resample_method_output (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">                Resampling method used to resize output predictions to match the input resolution. The accepted values</span>
<span class="sd">                are `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">            batch_size (`int`, *optional*, defaults to `1`):</span>
<span class="sd">                Batch size; only matters when setting `ensemble_size` or passing a tensor of images.</span>
<span class="sd">            ensembling_kwargs (`dict`, *optional*, defaults to `None`)</span>
<span class="sd">                Extra dictionary with arguments for precise ensembling control. The following options are available:</span>
<span class="sd">                - reduction (`str`, *optional*, defaults to `&quot;closest&quot;`): Defines the ensembling function applied in</span>
<span class="sd">                  every pixel location, can be either `&quot;closest&quot;` or `&quot;mean&quot;`.</span>
<span class="sd">            latents (`ms.Tensor`, *optional*, defaults to `None`):</span>
<span class="sd">                Latent noise tensors to replace the random initialization. These can be taken from the previous</span>
<span class="sd">                function call&#39;s output.</span>
<span class="sd">            generator (`np.random.Generator`, or `List[np.random.Generator]`, *optional*, defaults to `None`):</span>
<span class="sd">                Random number generator object to ensure reproducibility.</span>
<span class="sd">            output_type (`str`, *optional*, defaults to `&quot;np&quot;`):</span>
<span class="sd">                Preferred format of the output&#39;s `prediction` and the optional `uncertainty` fields. The accepted</span>
<span class="sd">                values are: `&quot;np&quot;` (numpy array) or `&quot;pt&quot;` (torch tensor).</span>
<span class="sd">            output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                When enabled, the output&#39;s `uncertainty` field contains the predictive uncertainty map, provided that</span>
<span class="sd">                the `ensemble_size` argument is set to a value above 2.</span>
<span class="sd">            output_latent (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                When enabled, the output&#39;s `latent` field contains the latent codes corresponding to the predictions</span>
<span class="sd">                within the ensemble. These codes can be saved, modified, and used for subsequent calls with the</span>
<span class="sd">                `latents` argument.</span>
<span class="sd">            return_dict (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                Whether or not to return a [`~pipelines.marigold.MarigoldDepthOutput`] instead of a plain tuple.</span>

<span class="sd">        Examples:</span>

<span class="sd">        Returns:</span>
<span class="sd">            [`~pipelines.marigold.MarigoldNormalsOutput`] or `tuple`:</span>
<span class="sd">                If `return_dict` is `True`, [`~pipelines.marigold.MarigoldNormalsOutput`] is returned, otherwise a</span>
<span class="sd">                `tuple` is returned where the first element is the prediction, the second element is the uncertainty</span>
<span class="sd">                (or `None`), and the third is the latent (or `None`).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 0. Resolving variables.</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># Model-specific optimal default values leading to fast and reasonable results.</span>
        <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_inference_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_denoising_steps</span>
        <span class="k">if</span> <span class="n">processing_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">processing_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_processing_resolution</span>

        <span class="c1"># 1. Check inputs.</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inputs</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">ensemble_size</span><span class="p">,</span>
            <span class="n">processing_resolution</span><span class="p">,</span>
            <span class="n">resample_method_input</span><span class="p">,</span>
            <span class="n">resample_method_output</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">ensembling_kwargs</span><span class="p">,</span>
            <span class="n">latents</span><span class="p">,</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="n">output_type</span><span class="p">,</span>
            <span class="n">output_uncertainty</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 2. Prepare empty text conditioning.</span>
        <span class="c1"># Model invocation: self.tokenizer, self.text_encoder.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">text_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
                <span class="n">prompt</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;do_not_pad&quot;</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text_input_ids</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">text_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span><span class="n">text_input_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [1,2,1024]</span>

        <span class="c1"># 3. Preprocess input images. This function loads input image or images of compatible dimensions `(H, W)`,</span>
        <span class="c1"># optionally downsamples them to the `processing_resolution` `(PH, PW)`, where</span>
        <span class="c1"># `max(PH, PW) == processing_resolution`, and pads the dimensions to `(PPH, PPW)` such that these values are</span>
        <span class="c1"># divisible by the latent space downscaling factor (typically 8 in Stable Diffusion). The default value `None`</span>
        <span class="c1"># of `processing_resolution` resolves to the optimal value from the model config. It is a recommended mode of</span>
        <span class="c1"># operation and leads to the most reasonable results. Using the native image resolution or any other processing</span>
        <span class="c1"># resolution can lead to loss of either fine details or global context in the output predictions.</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">original_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">processing_resolution</span><span class="p">,</span> <span class="n">resample_method_input</span><span class="p">,</span> <span class="n">dtype</span>
        <span class="p">)</span>  <span class="c1"># [N,3,PPH,PPW]</span>

        <span class="c1"># 4. Encode input image into latent space. At this step, each of the `N` input images is represented with `E`</span>
        <span class="c1"># ensemble members. Each ensemble member is an independent diffused prediction, just initialized independently.</span>
        <span class="c1"># Latents of each such predictions across all input images and all ensemble members are represented in the</span>
        <span class="c1"># `pred_latent` variable. The variable `image_latent` is of the same shape: it contains each input image encoded</span>
        <span class="c1"># into latent space and replicated `E` times. The latents can be either generated (see `generator` to ensure</span>
        <span class="c1"># reproducibility), or passed explicitly via the `latents` argument. The latter can be set outside the pipeline</span>
        <span class="c1"># code. For example, in the Marigold-LCM video processing demo, the latents initialization of a frame is taken</span>
        <span class="c1"># as a convex combination of the latents output of the pipeline for the previous frame and a newly-sampled</span>
        <span class="c1"># noise. This behavior can be achieved by setting the `output_latent` argument to `True`. The latent space</span>
        <span class="c1"># dimensions are `(h, w)`. Encoding into latent space happens in batches of size `batch_size`.</span>
        <span class="c1"># Model invocation: self.vae.encoder.</span>
        <span class="n">image_latent</span><span class="p">,</span> <span class="n">pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_latents</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span>
        <span class="p">)</span>  <span class="c1"># [N*E,4,h,w], [N*E,4,h,w]</span>

        <span class="k">del</span> <span class="n">image</span>

        <span class="n">batch_empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [B,1024,2]</span>

        <span class="c1"># 5. Process the denoising loop. All `N * E` latents are processed sequentially in batches of size `batch_size`.</span>
        <span class="c1"># The unet model takes concatenated latent spaces of the input image and the predicted modality as an input, and</span>
        <span class="c1"># outputs noise for the predicted modality&#39;s latent space. The number of denoising diffusion steps is defined by</span>
        <span class="c1"># `num_inference_steps`. It is either set directly, or resolves to the optimal value specific to the loaded</span>
        <span class="c1"># model.</span>
        <span class="c1"># Model invocation: self.unet.</span>
        <span class="n">pred_latents</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Marigold predictions...&quot;</span>
        <span class="p">):</span>
            <span class="n">batch_image_latent</span> <span class="o">=</span> <span class="n">image_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
            <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
            <span class="n">effective_batch_size</span> <span class="o">=</span> <span class="n">batch_image_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">batch_empty_text_embedding</span><span class="p">[:</span><span class="n">effective_batch_size</span><span class="p">]</span>  <span class="c1"># [B,2,1024]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_inference_steps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Diffusion steps...&quot;</span><span class="p">):</span>
                <span class="n">batch_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_image_latent</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B,8,h,w]</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">(</span><span class="n">batch_latent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
                <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[</span>
                    <span class="mi">0</span>
                <span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>

            <span class="n">pred_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_pred_latent</span><span class="p">)</span>

        <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pred_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

        <span class="k">del</span> <span class="p">(</span>
            <span class="n">pred_latents</span><span class="p">,</span>
            <span class="n">image_latent</span><span class="p">,</span>
            <span class="n">batch_empty_text_embedding</span><span class="p">,</span>
            <span class="n">batch_image_latent</span><span class="p">,</span>
            <span class="n">batch_pred_latent</span><span class="p">,</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">batch_latent</span><span class="p">,</span>
            <span class="n">noise</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 6. Decode predictions from latent into pixel space. The resulting `N * E` predictions have shape `(PPH, PPW)`,</span>
        <span class="c1"># which requires slight postprocessing. Decoding into pixel space happens in batches of size `batch_size`.</span>
        <span class="c1"># Model invocation: self.vae.decoder.</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">decode_prediction</span><span class="p">(</span><span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># [N*E,3,PPH,PPW]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_latent</span><span class="p">:</span>
            <span class="n">pred_latent</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 7. Remove padding. The output shape is (PH, PW).</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">unpad_image</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>  <span class="c1"># [N*E,3,PH,PW]</span>

        <span class="c1"># 8. Ensemble and compute uncertainty (when `output_uncertainty` is set). This code treats each of the `N`</span>
        <span class="c1"># groups of `E` ensemble predictions independently. For each group it computes an ensembled prediction of shape</span>
        <span class="c1"># `(PH, PW)` and an optional uncertainty map of the same dimensions. After computing this pair of outputs for</span>
        <span class="c1"># each group independently, it stacks them respectively into batches of `N` almost final predictions and</span>
        <span class="c1"># uncertainty maps.</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="o">*</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># [N,E,3,PH,PW]</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_normals</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output_uncertainty</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">ensembling_kwargs</span> <span class="ow">or</span> <span class="p">{}))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">)</span>
            <span class="p">]</span>  <span class="c1"># [ [[1,3,PH,PW], [1,1,PH,PW]], ... ]</span>
            <span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [[1,3,PH,PW], ... ], [[1,1,PH,PW], ... ]</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,3,PH,PW]</span>
            <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,1,PH,PW]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 9. If `match_input_resolution` is set, the output prediction and the uncertainty are upsampled to match the</span>
        <span class="c1"># input resolution `(H, W)`. This step may introduce upsampling artifacts, and therefore can be disabled.</span>
        <span class="c1"># After upsampling, the native resolution normal maps are renormalized to unit length to reduce the artifacts.</span>
        <span class="c1"># Depending on the downstream use-case, upsampling can be also chosen based on the tolerated artifacts by</span>
        <span class="c1"># setting the `resample_method_output` parameter (e.g., to `&quot;nearest&quot;`).</span>
        <span class="k">if</span> <span class="n">match_input_resolution</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
                <span class="n">prediction</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>  <span class="c1"># [N,3,H,W]</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_normals</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [N,3,H,W]</span>
            <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
                    <span class="n">uncertainty</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>  <span class="c1"># [N,1,H,W]</span>

        <span class="c1"># 10. Prepare the final outputs.</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [N,H,W,3]</span>
            <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">)</span>  <span class="c1"># [N,H,W,1]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">pred_latent</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">MarigoldNormalsOutput</span><span class="p">(</span>
            <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">latent</span><span class="o">=</span><span class="n">pred_latent</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Copied from diffusers.pipelines.marigold.pipeline_marigold_depth.MarigoldDepthPipeline.prepare_latents</span>
    <span class="k">def</span> <span class="nf">prepare_latents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">],</span>
        <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="k">def</span> <span class="nf">retrieve_latents</span><span class="p">(</span><span class="n">encoder_output</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">ops</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span>
                <span class="n">encoder_output</span>
            <span class="p">),</span> <span class="s2">&quot;Could not access latents of provided encoder_output which is not a tensor&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="p">,</span> <span class="s2">&quot;diag_gauss_dist&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">diag_gauss_dist</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">encoder_output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">encoder_output</span>

        <span class="n">image_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">retrieve_latents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># [N,4,h,w]</span>
        <span class="n">image_latent</span> <span class="o">=</span> <span class="n">image_latent</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span>
        <span class="n">image_latent</span> <span class="o">=</span> <span class="n">image_latent</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">ensemble_size</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

        <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">latents</span>
        <span class="k">if</span> <span class="n">pred_latent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">randn_tensor</span><span class="p">(</span>
                <span class="n">image_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">image_latent</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

        <span class="k">return</span> <span class="n">image_latent</span><span class="p">,</span> <span class="n">pred_latent</span>

    <span class="k">def</span> <span class="nf">decode_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred_latent</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_channels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latent_channels</span><span class="si">}</span><span class="s2">,H,W]; got </span><span class="si">{</span><span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">pred_latent</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B,3,H,W]</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_full_z_range</span><span class="p">:</span>
            <span class="n">prediction</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="mf">0.5</span>
            <span class="n">prediction</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="mf">0.5</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_normals</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [B,3,H,W]</span>

        <span class="k">return</span> <span class="n">prediction</span>  <span class="c1"># [B,3,H,W]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">normalize_normals</span><span class="p">(</span><span class="n">normals</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">normals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">normals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,3,H,W]; got </span><span class="si">{</span><span class="n">normals</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">normals</span> <span class="o">/=</span> <span class="n">norm</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">normals</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ensemble_normals</span><span class="p">(</span>
        <span class="n">normals</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;closest&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensembles the normals maps represented by the `normals` tensor with expected shape `(B, 3, H, W)`, where B is</span>
<span class="sd">        the number of ensemble members for a given prediction of size `(H x W)`.</span>

<span class="sd">        Args:</span>
<span class="sd">            normals (`ms.Tensor`):</span>
<span class="sd">                Input ensemble normals maps.</span>
<span class="sd">            output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">                Whether to output uncertainty map.</span>
<span class="sd">            reduction (`str`, *optional*, defaults to `&quot;closest&quot;`):</span>
<span class="sd">                Reduction method used to ensemble aligned predictions. The accepted values are: `&quot;closest&quot;` and</span>
<span class="sd">                `&quot;mean&quot;`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tensor of aligned and ensembled normals maps with shape `(1, 3, H, W)` and optionally a tensor of</span>
<span class="sd">            uncertainties of shape `(1, 1, H, W)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">normals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">normals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,3,H,W]; got </span><span class="si">{</span><span class="n">normals</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized reduction method: </span><span class="si">{</span><span class="n">reduction</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">mean_normals</span> <span class="o">=</span> <span class="n">normals</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [1,3,H,W]</span>
        <span class="n">mean_normals</span> <span class="o">=</span> <span class="n">MarigoldNormalsPipeline</span><span class="o">.</span><span class="n">normalize_normals</span><span class="p">(</span><span class="n">mean_normals</span><span class="p">)</span>  <span class="c1"># [1,3,H,W]</span>

        <span class="n">sim_cos</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_normals</span> <span class="o">*</span> <span class="n">normals</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [E,1,H,W]</span>
        <span class="n">sim_cos</span> <span class="o">=</span> <span class="n">sim_cos</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># required to avoid NaN in uncertainty with fp16</span>

        <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">sim_cos</span><span class="o">.</span><span class="n">arccos</span><span class="p">()</span>  <span class="c1"># [E,1,H,W]</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">uncertainty</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">ms</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># [1,1,H,W]</span>

        <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mean_normals</span><span class="p">,</span> <span class="n">uncertainty</span>  <span class="c1"># [1,3,H,W], [1,1,H,W]</span>

        <span class="n">closest_indices</span> <span class="o">=</span> <span class="n">sim_cos</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [1,1,H,W]</span>
        <span class="n">closest_indices</span> <span class="o">=</span> <span class="n">closest_indices</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [1,3,H,W]</span>
        <span class="n">closest_normals</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">gather_elements</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">closest_indices</span><span class="p">)</span>  <span class="c1"># [1,3,H,W]</span>

        <span class="k">return</span> <span class="n">closest_normals</span><span class="p">,</span> <span class="n">uncertainty</span>  <span class="c1"># [1,3,H,W], [1,1,H,W]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="mindone.diffusers.MarigoldNormalsPipeline.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mindone</span><span class="o">.</span><span class="n">diffusers</span><span class="o">.</span><span class="n">MarigoldNormalsPipeline</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">num_inference_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">processing_resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">match_input_resolution</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resample_method_input</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ensembling_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;np&#39;</span><span class="p">,</span> <span class="n">output_uncertainty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_latent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#mindone.diffusers.MarigoldNormalsPipeline.__call__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Function invoked when calling the pipeline.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>num_inference_steps</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Number of denoising diffusion steps during inference. The default value <code>None</code> results in automatic
selection. The number of steps should be at least 10 with the full Marigold models, and between 1 and 4
for Marigold-LCM models.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>ensemble_size</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Number of ensemble predictions. Recommended values are 5 and higher for better precision, or 1 for
faster inference.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, defaults to `1`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>1</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>processing_resolution</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Effective processing resolution. When set to <code>0</code>, matches the larger input image dimension. This
produces crisper predictions, but may also lead to the overall loss of global context. The default
value <code>None</code> resolves to the optimal value from the model config.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>match_input_resolution</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>When enabled, the output prediction is resized to match the input dimensions. When disabled, the longer
side of the output will equal to <code>processing_resolution</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `True`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resample_method_input</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Resampling method used to resize input images to <code>processing_resolution</code>. The accepted values are:
<code>"nearest"</code>, <code>"nearest-exact"</code>, <code>"bilinear"</code>, <code>"bicubic"</code>, or <code>"area"</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;bilinear&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;bilinear&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resample_method_output</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Resampling method used to resize output predictions to match the input resolution. The accepted values
are <code>"nearest"</code>, <code>"nearest-exact"</code>, <code>"bilinear"</code>, <code>"bicubic"</code>, or <code>"area"</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;bilinear&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;bilinear&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>batch_size</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Batch size; only matters when setting <code>ensemble_size</code> or passing a tensor of images.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`int`, *optional*, defaults to `1`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>1</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>latents</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Latent noise tensors to replace the random initialization. These can be taken from the previous
function call's output.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`ms.Tensor`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>generator</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Random number generator object to ensure reproducibility.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`np.random.Generator`, or `List[np.random.Generator]`, *optional*, defaults to `None`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_type</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Preferred format of the output's <code>prediction</code> and the optional <code>uncertainty</code> fields. The accepted
values are: <code>"np"</code> (numpy array) or <code>"pt"</code> (torch tensor).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;np&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;np&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_uncertainty</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>When enabled, the output's <code>uncertainty</code> field contains the predictive uncertainty map, provided that
the <code>ensemble_size</code> argument is set to a value above 2.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_latent</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>When enabled, the output's <code>latent</code> field contains the latent codes corresponding to the predictions
within the ensemble. These codes can be saved, modified, and used for subsequent calls with the
<code>latents</code> argument.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>return_dict</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether or not to return a [<code>~pipelines.marigold.MarigoldDepthOutput</code>] instead of a plain tuple.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>False</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>
        


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">RETURNS</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td class="doc-returns-details">
              <div class="doc-md-description">
                <p>[<code>~pipelines.marigold.MarigoldNormalsOutput</code>] or <code>tuple</code>:
If <code>return_dict</code> is <code>True</code>, [<code>~pipelines.marigold.MarigoldNormalsOutput</code>] is returned, otherwise a
<code>tuple</code> is returned where the first element is the prediction, the second element is the uncertainty
(or <code>None</code>), and the third is the latent (or <code>None</code>).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_normals.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">PipelineImageInput</span><span class="p">,</span>
    <span class="n">num_inference_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ensemble_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">processing_resolution</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">match_input_resolution</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">resample_method_input</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
    <span class="n">resample_method_output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ensembling_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;np&quot;</span><span class="p">,</span>
    <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_latent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function invoked when calling the pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (`PIL.Image.Image`, `np.ndarray`, `ms.Tensor`, `List[PIL.Image.Image]`, `List[np.ndarray]`),</span>
<span class="sd">            `List[ms.Tensor]`: An input image or images used as an input for the normals estimation task. For</span>
<span class="sd">            arrays and tensors, the expected value range is between `[0, 1]`. Passing a batch of images is possible</span>
<span class="sd">            by providing a four-dimensional array or a tensor. Additionally, a list of images of two- or</span>
<span class="sd">            three-dimensional arrays or tensors can be passed. In the latter case, all list elements must have the</span>
<span class="sd">            same width and height.</span>
<span class="sd">        num_inference_steps (`int`, *optional*, defaults to `None`):</span>
<span class="sd">            Number of denoising diffusion steps during inference. The default value `None` results in automatic</span>
<span class="sd">            selection. The number of steps should be at least 10 with the full Marigold models, and between 1 and 4</span>
<span class="sd">            for Marigold-LCM models.</span>
<span class="sd">        ensemble_size (`int`, defaults to `1`):</span>
<span class="sd">            Number of ensemble predictions. Recommended values are 5 and higher for better precision, or 1 for</span>
<span class="sd">            faster inference.</span>
<span class="sd">        processing_resolution (`int`, *optional*, defaults to `None`):</span>
<span class="sd">            Effective processing resolution. When set to `0`, matches the larger input image dimension. This</span>
<span class="sd">            produces crisper predictions, but may also lead to the overall loss of global context. The default</span>
<span class="sd">            value `None` resolves to the optimal value from the model config.</span>
<span class="sd">        match_input_resolution (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">            When enabled, the output prediction is resized to match the input dimensions. When disabled, the longer</span>
<span class="sd">            side of the output will equal to `processing_resolution`.</span>
<span class="sd">        resample_method_input (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">            Resampling method used to resize input images to `processing_resolution`. The accepted values are:</span>
<span class="sd">            `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">        resample_method_output (`str`, *optional*, defaults to `&quot;bilinear&quot;`):</span>
<span class="sd">            Resampling method used to resize output predictions to match the input resolution. The accepted values</span>
<span class="sd">            are `&quot;nearest&quot;`, `&quot;nearest-exact&quot;`, `&quot;bilinear&quot;`, `&quot;bicubic&quot;`, or `&quot;area&quot;`.</span>
<span class="sd">        batch_size (`int`, *optional*, defaults to `1`):</span>
<span class="sd">            Batch size; only matters when setting `ensemble_size` or passing a tensor of images.</span>
<span class="sd">        ensembling_kwargs (`dict`, *optional*, defaults to `None`)</span>
<span class="sd">            Extra dictionary with arguments for precise ensembling control. The following options are available:</span>
<span class="sd">            - reduction (`str`, *optional*, defaults to `&quot;closest&quot;`): Defines the ensembling function applied in</span>
<span class="sd">              every pixel location, can be either `&quot;closest&quot;` or `&quot;mean&quot;`.</span>
<span class="sd">        latents (`ms.Tensor`, *optional*, defaults to `None`):</span>
<span class="sd">            Latent noise tensors to replace the random initialization. These can be taken from the previous</span>
<span class="sd">            function call&#39;s output.</span>
<span class="sd">        generator (`np.random.Generator`, or `List[np.random.Generator]`, *optional*, defaults to `None`):</span>
<span class="sd">            Random number generator object to ensure reproducibility.</span>
<span class="sd">        output_type (`str`, *optional*, defaults to `&quot;np&quot;`):</span>
<span class="sd">            Preferred format of the output&#39;s `prediction` and the optional `uncertainty` fields. The accepted</span>
<span class="sd">            values are: `&quot;np&quot;` (numpy array) or `&quot;pt&quot;` (torch tensor).</span>
<span class="sd">        output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            When enabled, the output&#39;s `uncertainty` field contains the predictive uncertainty map, provided that</span>
<span class="sd">            the `ensemble_size` argument is set to a value above 2.</span>
<span class="sd">        output_latent (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            When enabled, the output&#39;s `latent` field contains the latent codes corresponding to the predictions</span>
<span class="sd">            within the ensemble. These codes can be saved, modified, and used for subsequent calls with the</span>
<span class="sd">            `latents` argument.</span>
<span class="sd">        return_dict (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether or not to return a [`~pipelines.marigold.MarigoldDepthOutput`] instead of a plain tuple.</span>

<span class="sd">    Examples:</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`~pipelines.marigold.MarigoldNormalsOutput`] or `tuple`:</span>
<span class="sd">            If `return_dict` is `True`, [`~pipelines.marigold.MarigoldNormalsOutput`] is returned, otherwise a</span>
<span class="sd">            `tuple` is returned where the first element is the prediction, the second element is the uncertainty</span>
<span class="sd">            (or `None`), and the third is the latent (or `None`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 0. Resolving variables.</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

    <span class="c1"># Model-specific optimal default values leading to fast and reasonable results.</span>
    <span class="k">if</span> <span class="n">num_inference_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_inference_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_denoising_steps</span>
    <span class="k">if</span> <span class="n">processing_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">processing_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_processing_resolution</span>

    <span class="c1"># 1. Check inputs.</span>
    <span class="n">num_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inputs</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">,</span>
        <span class="n">ensemble_size</span><span class="p">,</span>
        <span class="n">processing_resolution</span><span class="p">,</span>
        <span class="n">resample_method_input</span><span class="p">,</span>
        <span class="n">resample_method_output</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">ensembling_kwargs</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">,</span>
        <span class="n">output_type</span><span class="p">,</span>
        <span class="n">output_uncertainty</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 2. Prepare empty text conditioning.</span>
    <span class="c1"># Model invocation: self.tokenizer, self.text_encoder.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">text_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;do_not_pad&quot;</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">text_input_ids</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">text_inputs</span><span class="o">.</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_encoder</span><span class="p">(</span><span class="n">text_input_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [1,2,1024]</span>

    <span class="c1"># 3. Preprocess input images. This function loads input image or images of compatible dimensions `(H, W)`,</span>
    <span class="c1"># optionally downsamples them to the `processing_resolution` `(PH, PW)`, where</span>
    <span class="c1"># `max(PH, PW) == processing_resolution`, and pads the dimensions to `(PPH, PPW)` such that these values are</span>
    <span class="c1"># divisible by the latent space downscaling factor (typically 8 in Stable Diffusion). The default value `None`</span>
    <span class="c1"># of `processing_resolution` resolves to the optimal value from the model config. It is a recommended mode of</span>
    <span class="c1"># operation and leads to the most reasonable results. Using the native image resolution or any other processing</span>
    <span class="c1"># resolution can lead to loss of either fine details or global context in the output predictions.</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">original_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">processing_resolution</span><span class="p">,</span> <span class="n">resample_method_input</span><span class="p">,</span> <span class="n">dtype</span>
    <span class="p">)</span>  <span class="c1"># [N,3,PPH,PPW]</span>

    <span class="c1"># 4. Encode input image into latent space. At this step, each of the `N` input images is represented with `E`</span>
    <span class="c1"># ensemble members. Each ensemble member is an independent diffused prediction, just initialized independently.</span>
    <span class="c1"># Latents of each such predictions across all input images and all ensemble members are represented in the</span>
    <span class="c1"># `pred_latent` variable. The variable `image_latent` is of the same shape: it contains each input image encoded</span>
    <span class="c1"># into latent space and replicated `E` times. The latents can be either generated (see `generator` to ensure</span>
    <span class="c1"># reproducibility), or passed explicitly via the `latents` argument. The latter can be set outside the pipeline</span>
    <span class="c1"># code. For example, in the Marigold-LCM video processing demo, the latents initialization of a frame is taken</span>
    <span class="c1"># as a convex combination of the latents output of the pipeline for the previous frame and a newly-sampled</span>
    <span class="c1"># noise. This behavior can be achieved by setting the `output_latent` argument to `True`. The latent space</span>
    <span class="c1"># dimensions are `(h, w)`. Encoding into latent space happens in batches of size `batch_size`.</span>
    <span class="c1"># Model invocation: self.vae.encoder.</span>
    <span class="n">image_latent</span><span class="p">,</span> <span class="n">pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_latents</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span>
    <span class="p">)</span>  <span class="c1"># [N*E,4,h,w], [N*E,4,h,w]</span>

    <span class="k">del</span> <span class="n">image</span>

    <span class="n">batch_empty_text_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_text_embedding</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [B,1024,2]</span>

    <span class="c1"># 5. Process the denoising loop. All `N * E` latents are processed sequentially in batches of size `batch_size`.</span>
    <span class="c1"># The unet model takes concatenated latent spaces of the input image and the predicted modality as an input, and</span>
    <span class="c1"># outputs noise for the predicted modality&#39;s latent space. The number of denoising diffusion steps is defined by</span>
    <span class="c1"># `num_inference_steps`. It is either set directly, or resolves to the optimal value specific to the loaded</span>
    <span class="c1"># model.</span>
    <span class="c1"># Model invocation: self.unet.</span>
    <span class="n">pred_latents</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_images</span> <span class="o">*</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Marigold predictions...&quot;</span>
    <span class="p">):</span>
        <span class="n">batch_image_latent</span> <span class="o">=</span> <span class="n">image_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
        <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
        <span class="n">effective_batch_size</span> <span class="o">=</span> <span class="n">batch_image_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">batch_empty_text_embedding</span><span class="p">[:</span><span class="n">effective_batch_size</span><span class="p">]</span>  <span class="c1"># [B,2,1024]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_inference_steps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Diffusion steps...&quot;</span><span class="p">):</span>
            <span class="n">batch_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_image_latent</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [B,8,h,w]</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">(</span><span class="n">batch_latent</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>
            <span class="n">batch_pred_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">batch_pred_latent</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)[</span>
                <span class="mi">0</span>
            <span class="p">]</span>  <span class="c1"># [B,4,h,w]</span>

        <span class="n">pred_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_pred_latent</span><span class="p">)</span>

    <span class="n">pred_latent</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">pred_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N*E,4,h,w]</span>

    <span class="k">del</span> <span class="p">(</span>
        <span class="n">pred_latents</span><span class="p">,</span>
        <span class="n">image_latent</span><span class="p">,</span>
        <span class="n">batch_empty_text_embedding</span><span class="p">,</span>
        <span class="n">batch_image_latent</span><span class="p">,</span>
        <span class="n">batch_pred_latent</span><span class="p">,</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">batch_latent</span><span class="p">,</span>
        <span class="n">noise</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 6. Decode predictions from latent into pixel space. The resulting `N * E` predictions have shape `(PPH, PPW)`,</span>
    <span class="c1"># which requires slight postprocessing. Decoding into pixel space happens in batches of size `batch_size`.</span>
    <span class="c1"># Model invocation: self.vae.decoder.</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decode_prediction</span><span class="p">(</span><span class="n">pred_latent</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pred_latent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># [N*E,3,PPH,PPW]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_latent</span><span class="p">:</span>
        <span class="n">pred_latent</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 7. Remove padding. The output shape is (PH, PW).</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">unpad_image</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>  <span class="c1"># [N*E,3,PH,PW]</span>

    <span class="c1"># 8. Ensemble and compute uncertainty (when `output_uncertainty` is set). This code treats each of the `N`</span>
    <span class="c1"># groups of `E` ensemble predictions independently. For each group it computes an ensembled prediction of shape</span>
    <span class="c1"># `(PH, PW)` and an optional uncertainty map of the same dimensions. After computing this pair of outputs for</span>
    <span class="c1"># each group independently, it stacks them respectively into batches of `N` almost final predictions and</span>
    <span class="c1"># uncertainty maps.</span>
    <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">ensemble_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">ensemble_size</span><span class="p">,</span> <span class="o">*</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># [N,E,3,PH,PW]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_normals</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output_uncertainty</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">ensembling_kwargs</span> <span class="ow">or</span> <span class="p">{}))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_images</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># [ [[1,3,PH,PW], [1,1,PH,PW]], ... ]</span>
        <span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [[1,3,PH,PW], ... ], [[1,1,PH,PW], ... ]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,3,PH,PW]</span>
        <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [N,1,PH,PW]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 9. If `match_input_resolution` is set, the output prediction and the uncertainty are upsampled to match the</span>
    <span class="c1"># input resolution `(H, W)`. This step may introduce upsampling artifacts, and therefore can be disabled.</span>
    <span class="c1"># After upsampling, the native resolution normal maps are renormalized to unit length to reduce the artifacts.</span>
    <span class="c1"># Depending on the downstream use-case, upsampling can be also chosen based on the tolerated artifacts by</span>
    <span class="c1"># setting the `resample_method_output` parameter (e.g., to `&quot;nearest&quot;`).</span>
    <span class="k">if</span> <span class="n">match_input_resolution</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
            <span class="n">prediction</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>  <span class="c1"># [N,3,H,W]</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_normals</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [N,3,H,W]</span>
        <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">resize_antialias</span><span class="p">(</span>
                <span class="n">uncertainty</span><span class="p">,</span> <span class="n">original_resolution</span><span class="p">,</span> <span class="n">resample_method_output</span><span class="p">,</span> <span class="n">is_aa</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>  <span class="c1"># [N,1,H,W]</span>

    <span class="c1"># 10. Prepare the final outputs.</span>
    <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>  <span class="c1"># [N,H,W,3]</span>
        <span class="k">if</span> <span class="n">uncertainty</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_uncertainty</span><span class="p">:</span>
            <span class="n">uncertainty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">pt_to_numpy</span><span class="p">(</span><span class="n">uncertainty</span><span class="p">)</span>  <span class="c1"># [N,H,W,1]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">pred_latent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MarigoldNormalsOutput</span><span class="p">(</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
        <span class="n">latent</span><span class="o">=</span><span class="n">pred_latent</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="mindone.diffusers.MarigoldNormalsPipeline.ensemble_normals" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mindone</span><span class="o">.</span><span class="n">diffusers</span><span class="o">.</span><span class="n">MarigoldNormalsPipeline</span><span class="o">.</span><span class="n">ensemble_normals</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">output_uncertainty</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#mindone.diffusers.MarigoldNormalsPipeline.ensemble_normals" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Ensembles the normals maps represented by the <code>normals</code> tensor with expected shape <code>(B, 3, H, W)</code>, where B is
the number of ensemble members for a given prediction of size <code>(H x W)</code>.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>normals</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Input ensemble normals maps.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_uncertainty</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether to output uncertainty map.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`bool`, *optional*, defaults to `False`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>reduction</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Reduction method used to ensemble aligned predictions. The accepted values are: <code>"closest"</code> and
<code>"mean"</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`str`, *optional*, defaults to `&#34;closest&#34;`</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;closest&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">RETURNS</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <span class="doc-returns-annotation">
                    <code><span title="mindspore.Tensor">Tensor</span></code>
                </span>
            </td>
            <td class="doc-returns-details">
              <div class="doc-md-description">
                <p>A tensor of aligned and ensembled normals maps with shape <code>(1, 3, H, W)</code> and optionally a tensor of</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <span class="doc-returns-annotation">
                    <code><span title="typing.Optional">Optional</span>[<span title="mindspore.Tensor">Tensor</span>]</code>
                </span>
            </td>
            <td class="doc-returns-details">
              <div class="doc-md-description">
                <p>uncertainties of shape <code>(1, 1, H, W)</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_normals.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">ensemble_normals</span><span class="p">(</span>
    <span class="n">normals</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">output_uncertainty</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">reduction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;closest&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensembles the normals maps represented by the `normals` tensor with expected shape `(B, 3, H, W)`, where B is</span>
<span class="sd">    the number of ensemble members for a given prediction of size `(H x W)`.</span>

<span class="sd">    Args:</span>
<span class="sd">        normals (`ms.Tensor`):</span>
<span class="sd">            Input ensemble normals maps.</span>
<span class="sd">        output_uncertainty (`bool`, *optional*, defaults to `False`):</span>
<span class="sd">            Whether to output uncertainty map.</span>
<span class="sd">        reduction (`str`, *optional*, defaults to `&quot;closest&quot;`):</span>
<span class="sd">            Reduction method used to ensemble aligned predictions. The accepted values are: `&quot;closest&quot;` and</span>
<span class="sd">            `&quot;mean&quot;`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tensor of aligned and ensembled normals maps with shape `(1, 3, H, W)` and optionally a tensor of</span>
<span class="sd">        uncertainties of shape `(1, 1, H, W)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">normals</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">normals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expecting 4D tensor of shape [B,3,H,W]; got </span><span class="si">{</span><span class="n">normals</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reduction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized reduction method: </span><span class="si">{</span><span class="n">reduction</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">mean_normals</span> <span class="o">=</span> <span class="n">normals</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [1,3,H,W]</span>
    <span class="n">mean_normals</span> <span class="o">=</span> <span class="n">MarigoldNormalsPipeline</span><span class="o">.</span><span class="n">normalize_normals</span><span class="p">(</span><span class="n">mean_normals</span><span class="p">)</span>  <span class="c1"># [1,3,H,W]</span>

    <span class="n">sim_cos</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_normals</span> <span class="o">*</span> <span class="n">normals</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [E,1,H,W]</span>
    <span class="n">sim_cos</span> <span class="o">=</span> <span class="n">sim_cos</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># required to avoid NaN in uncertainty with fp16</span>

    <span class="n">uncertainty</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">output_uncertainty</span><span class="p">:</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">sim_cos</span><span class="o">.</span><span class="n">arccos</span><span class="p">()</span>  <span class="c1"># [E,1,H,W]</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">uncertainty</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_dims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="n">ms</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># [1,1,H,W]</span>

    <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mean_normals</span><span class="p">,</span> <span class="n">uncertainty</span>  <span class="c1"># [1,3,H,W], [1,1,H,W]</span>

    <span class="n">closest_indices</span> <span class="o">=</span> <span class="n">sim_cos</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [1,1,H,W]</span>
    <span class="n">closest_indices</span> <span class="o">=</span> <span class="n">closest_indices</span><span class="o">.</span><span class="n">tile</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [1,3,H,W]</span>
    <span class="n">closest_normals</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">gather_elements</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">closest_indices</span><span class="p">)</span>  <span class="c1"># [1,3,H,W]</span>

    <span class="k">return</span> <span class="n">closest_normals</span><span class="p">,</span> <span class="n">uncertainty</span>  <span class="c1"># [1,3,H,W], [1,1,H,W]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mindone.diffusers.pipelines.marigold.pipeline_marigold_depth.MarigoldDepthOutput" class="doc doc-heading">
            <code>mindone.diffusers.pipelines.marigold.pipeline_marigold_depth.MarigoldDepthOutput</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#mindone.diffusers.pipelines.marigold.pipeline_marigold_depth.MarigoldDepthOutput" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="mindone.diffusers.utils.BaseOutput">BaseOutput</span></code></p>


        <p>Output class for Marigold monocular depth prediction pipeline.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>prediction</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Predicted depth maps with values in the range [0, 1]. The shape is always <span class="arithmatex">\(numimages        imes 1  imes height
    imes width\)</span>, regardless of whether the images were passed as a 4D array or a list.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`np.ndarray`, `ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>uncertainty</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Uncertainty maps computed from the ensemble, with values in the range [0, 1]. The shape is <span class="arithmatex">\(numimages
    imes 1  imes height     imes width\)</span>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`None`, `np.ndarray`, `ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>latent</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Latent features corresponding to the predictions, compatible with the <code>latents</code> argument of the pipeline.
The shape is <span class="arithmatex">\(numimages * numensemble       imes 4  imes latentheight       imes latentwidth\)</span>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`None`, `ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_depth.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MarigoldDepthOutput</span><span class="p">(</span><span class="n">BaseOutput</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Output class for Marigold monocular depth prediction pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        prediction (`np.ndarray`, `ms.Tensor`):</span>
<span class="sd">            Predicted depth maps with values in the range [0, 1]. The shape is always $numimages \times 1 \times height</span>
<span class="sd">            \times width$, regardless of whether the images were passed as a 4D array or a list.</span>
<span class="sd">        uncertainty (`None`, `np.ndarray`, `ms.Tensor`):</span>
<span class="sd">            Uncertainty maps computed from the ensemble, with values in the range [0, 1]. The shape is $numimages</span>
<span class="sd">            \times 1 \times height \times width$.</span>
<span class="sd">        latent (`None`, `ms.Tensor`):</span>
<span class="sd">            Latent features corresponding to the predictions, compatible with the `latents` argument of the pipeline.</span>
<span class="sd">            The shape is $numimages * numensemble \times 4 \times latentheight \times latentwidth$.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="n">latent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="mindone.diffusers.pipelines.marigold.pipeline_marigold_normals.MarigoldNormalsOutput" class="doc doc-heading">
            <code>mindone.diffusers.pipelines.marigold.pipeline_marigold_normals.MarigoldNormalsOutput</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#mindone.diffusers.pipelines.marigold.pipeline_marigold_normals.MarigoldNormalsOutput" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="mindone.diffusers.utils.BaseOutput">BaseOutput</span></code></p>


        <p>Output class for Marigold monocular normals prediction pipeline.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>prediction</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Predicted normals with values in the range [-1, 1]. The shape is always <span class="arithmatex">\(numimages  imes 3  imes height
    imes width\)</span>, regardless of whether the images were passed as a 4D array or a list.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`np.ndarray`, `ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>uncertainty</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Uncertainty maps computed from the ensemble, with values in the range [0, 1]. The shape is <span class="arithmatex">\(numimages
    imes 1  imes height     imes width\)</span>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`None`, `np.ndarray`, `ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>latent</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Latent features corresponding to the predictions, compatible with the <code>latents</code> argument of the pipeline.
The shape is <span class="arithmatex">\(numimages * numensemble       imes 4  imes latentheight       imes latentwidth\)</span>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code>`None`, `ms.Tensor`</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>mindone/diffusers/pipelines/marigold/pipeline_marigold_normals.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">MarigoldNormalsOutput</span><span class="p">(</span><span class="n">BaseOutput</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Output class for Marigold monocular normals prediction pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        prediction (`np.ndarray`, `ms.Tensor`):</span>
<span class="sd">            Predicted normals with values in the range [-1, 1]. The shape is always $numimages \times 3 \times height</span>
<span class="sd">            \times width$, regardless of whether the images were passed as a 4D array or a list.</span>
<span class="sd">        uncertainty (`None`, `np.ndarray`, `ms.Tensor`):</span>
<span class="sd">            Uncertainty maps computed from the ensemble, with values in the range [0, 1]. The shape is $numimages</span>
<span class="sd">            \times 1 \times height \times width$.</span>
<span class="sd">        latent (`None`, `ms.Tensor`):</span>
<span class="sd">            Latent features corresponding to the predictions, compatible with the `latents` argument of the pipeline.</span>
<span class="sd">            The shape is $numimages * numensemble \times 4 \times latentheight \times latentwidth$.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="n">latent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 1, 2024</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 1, 2024</span>
  </span>

    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:77485245+wcrzlh@users.noreply.github.com">Chaoran Wei</a>
    </nav>
  </span>

    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../latent_diffusion/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Latent Diffusion">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Latent Diffusion
              </div>
            </div>
          </a>
        
        
          
          <a href="../pixart/" class="md-footer__link md-footer__link--next" aria-label="Next: PixArt-Î±">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                PixArt-Î±
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2024 MindSpore Lab
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="mailto:mindspore-lab@huawei.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/mindspore-lab/mindone" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.zhihu.com/people/mindsporelab" target="_blank" rel="noopener" title="www.zhihu.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.top", "navigation.footer", "toc.follow", "search.highlight", "search.share", "search.suggest", "content.action.view", "content.action.edit", "content.tabs.link", "content.code.copy", "content.code.select", "content.code.annotations"], "search": "../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>