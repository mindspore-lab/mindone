# Video Captioning

Human labeling of videos is expensive and time-consuming.
We adopt powerful image captioning models to generate
captions for videos. Empirically, we observe that Qwen2-VL
consistently provide high-quality captions for videos.
Qwen2-VL-72B model showcases top-tier performance across
most metrics, often surpassing even closed-source
models like GPT-4o and Claude-3.5-Sonnet.


## Qwen2-VL Captioning

First, you may download the model on HuggingFace (or you may load them directly without download):

| Model        | Link                                                                         |
|--------------|------------------------------------------------------------------------------|
| Qwen2-VL-2B-Instruct  | [Qwen/Qwen2-VL-2B · Hugging Face](https://huggingface.co/Qwen/Qwen2-VL-2B-Instruct)   |
| Qwen2-VL-7B-Instruct  | [Qwen/Qwen2-VL-7B · Hugging Face](https://huggingface.co/Qwen/Qwen2-VL-7B-Instruct)   |
| Qwen2-VL-72B-Instruct | [Qwen/Qwen2-VL-72B · Hugging Face](https://huggingface.co/Qwen/Qwen2-VL-72B-Instruct) |


Currently, we only support captioning on Ascend.

```bash
export PYTHONPATH=$(pwd)
msrun --worker_num=2 --local_worker_num=2 --join=True \
 --log_dir=msrun_log pipeline/captioning/caption_qwen2vl.py \
 /path/to/meta.csv
```
Modify `worker_num` and `local_worker_num` based on your resource.

We support the following arguments for Qwen2-VL captioning:

- `pretrained_model_name_or_path`: the Qwen2-VL model directory.
- `question`: The prompt used to generate captions. Default "Describe the video in details".
- `max_new_tokens`: Maximum new tokens generated by Qwen2-VL, default 200.
- `height`: Resized video height. Default 448.
- `width`: Resized video width. Default 672.
- `fps`: Frame rate of the resized video. Default 4.
- `bs`: Batch size. Default 1.
- `skip_if_existing`: Skip processing if output already exists. Default False.

**NOTE:** When running large-scale parallel inference,
the default `HCCL_CONNECT_TIMEOUT` setting might be
insufficient, potentially causing runtime errors with
AllGather operations. To avoid this issue, consider
setting `export HCCL_CONNECT_TIMEOUT=7200` (corresponds to
7200 seconds) or adjusting it according to your
specific needs.

Additionally, an empty caption will be generated if the
input exceeds the memory usage limit. You may try to
reduce the height, width, or fps to avoid this issue.
